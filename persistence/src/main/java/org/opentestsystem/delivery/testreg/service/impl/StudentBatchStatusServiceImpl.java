package org.opentestsystem.delivery.testreg.service.impl;

import org.opentestsystem.delivery.testreg.domain.StudentBatchError;
import org.opentestsystem.delivery.testreg.domain.StudentBatchStatus;
import org.opentestsystem.delivery.testreg.persistence.batch.StudentBatchStatusRepository;
import org.opentestsystem.delivery.testreg.service.StudentBatchStatusService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.Date;

/**
 * Created by fairway on 7/11/16.
 */
@Service
public class StudentBatchStatusServiceImpl implements StudentBatchStatusService {

    @Autowired
    private StudentBatchStatusRepository studentBatchStatusRepository;

    public StudentBatchStatus getStudentBatchStatus(String batchId) {
        return studentBatchStatusRepository.findById(batchId);
    }

    public String createStudentBatchStatus(int numberSubmitted, boolean isUpsert, String submittedBy, String stateCode) {
        StudentBatchStatus studentBatchStatus = new StudentBatchStatus();
        studentBatchStatus.setUpsert(isUpsert);
        studentBatchStatus.setNumSubmitted(numberSubmitted);
        studentBatchStatus.setExceptions(new ArrayList<StudentBatchError>());
        studentBatchStatus.setSubmittedBy(submittedBy);
        studentBatchStatus.setSubmittedDate(new Date());
        studentBatchStatus.setStateCode(stateCode);
        return studentBatchStatusRepository.create(studentBatchStatus);
    }

    @Override
    public void logBatchError(String ssid, String errorMessage, String batchId) {
        studentBatchStatusRepository.logBatchError(new StudentBatchError(ssid, errorMessage), batchId);
    }

    @Override
    public void logBatchSuccess(String batchId) {
        studentBatchStatusRepository.logBatchSuccess(batchId);
    }

    private boolean isAuthorizedForState(String stateCode) {

        /*
            mongo.db.permissions(
         */

        return false;
    }
}
