package org.opentestsystem.delivery.testreg.service.impl;

import org.opentestsystem.delivery.testadmin.service.TestStatusService;
import org.opentestsystem.delivery.testreg.domain.FormatType;
import org.opentestsystem.delivery.testreg.domain.Student;
import org.opentestsystem.delivery.testreg.domain.StudentUpsert;
import org.opentestsystem.delivery.testreg.service.ExternalStudentService;
import org.opentestsystem.delivery.testreg.service.StudentService;
import org.opentestsystem.delivery.testreg.service.TestRegPersister;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.mongodb.core.MongoOperations;
import org.springframework.stereotype.Service;

/**
 * Created by fairway on 7/11/16.
 */
@Service
public class ExternalStudentServiceImpl implements ExternalStudentService {

    @Autowired
    private TestRegPersister studentRepository;

    @Autowired
    private StudentService studentService;

    @Autowired
    private TestStatusService testStatusService;

    @Override
    public StudentUpsert upsertStudent(Student student) {
        StudentUpsert studentUpsert = new StudentUpsert();
        Student existingStudent = studentService.findByStudentIdAndStateAbbreviation(student.getEntityId(),student.getStateAbbreviation());
        if(existingStudent != null) {
            student.setId(existingStudent.getId());
        }
        studentRepository.saveDomainObject(student);
        studentUpsert.setInsert(existingStudent == null);
        studentUpsert.setLocation(student.getUrl());
        return studentUpsert;
    }

    @Override
    public boolean deleteStudent(String ssid, String stateCode) {
        Student student = studentService.findByStudentIdAndStateAbbreviation(ssid, stateCode);
        if(student == null) return false;
        testStatusService.deleteTestStatus(ssid, stateCode);
        studentRepository.deleteDomainObject(student.getId(), FormatType.STUDENT);
        return true;
    }
}
