/*******************************************************************************
 * Educational Online Test Delivery System
 * Copyright (c) 2013 American Institutes for Research
 *
 * Distributed under the AIR Open Source License, Version 1.0
 * See accompanying file AIR-License-1_0.txt or at
 * http://www.smarterapp.org/documents/American_Institutes_for_Research_Open_Source_Software_License.pdf
 ******************************************************************************/

package org.opentestsystem.delivery.testreg.persistence.criteria;

import static org.opentestsystem.delivery.testreg.persistence.criteria.verifiers.VerifierUtils.addFieldError;

import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

import org.opentestsystem.delivery.testreg.domain.Accommodation;
import org.opentestsystem.delivery.testreg.domain.Action;
import org.opentestsystem.delivery.testreg.domain.DistrictEntity;
import org.opentestsystem.delivery.testreg.domain.ExplicitEligibility;
import org.opentestsystem.delivery.testreg.domain.InstitutionEntity;
import org.opentestsystem.delivery.testreg.domain.Sb11Entity;
import org.opentestsystem.delivery.testreg.domain.Sb11NonEntity;
import org.opentestsystem.delivery.testreg.domain.Sb11SuperEntity;
import org.opentestsystem.delivery.testreg.domain.Student;
import org.opentestsystem.delivery.testreg.domain.StudentGroup;
import org.opentestsystem.delivery.testreg.domain.TestRegistrationBase;
import org.opentestsystem.delivery.testreg.domain.User;
import org.opentestsystem.delivery.testreg.persistence.StudentRepository;
import org.opentestsystem.delivery.testreg.service.Sb11EntityRepositoryService;
import org.opentestsystem.delivery.testreg.service.TestRegUserDetailsService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.stereotype.Component;
import org.springframework.validation.FieldError;

@Component
public class FileUploadSecurityValidator implements BusinessValidator<TestRegistrationBase> {

    private static final Logger LOGGER = LoggerFactory.getLogger(FileUploadSecurityValidator.class);

    @Autowired
    private Sb11EntityRepositoryService sb11EntityService;

    @Qualifier("userDetailService")
    @Autowired
    private TestRegUserDetailsService testRegUserDetailsService;

    @Autowired
    private StudentRepository studentRepository;

    @Override
    public Action getAction() {
        throw new UnsupportedOperationException("This operation is not supported for this object");
    }

    @Override
    public boolean supports(final Class<? extends TestRegistrationBase> clazz) {
        return TestRegistrationBase.class.isAssignableFrom(clazz);
    }

    @Override
    public List<FieldError> validate(final TestRegistrationBase testRegistrationBase) {

        List<FieldError> errors = new ArrayList<>();
        Set<String> map = testRegUserDetailsService.getMongoIdsOfEntitiesCurrentUserHasAccessTo();

        if (testRegistrationBase instanceof Sb11Entity) {
            LOGGER.debug("validating an Sb11Entity...");
            validateSb11Entity((Sb11Entity) testRegistrationBase, errors, map);
        } else if (testRegistrationBase instanceof Sb11NonEntity) {
            LOGGER.debug("validating an Sb11NonEntity...");
            if (testRegistrationBase instanceof Accommodation) {
                validateAccommodation((Accommodation) testRegistrationBase, errors, map);
            } else if (testRegistrationBase instanceof ExplicitEligibility) {
                validateExplicitEligibility((ExplicitEligibility) testRegistrationBase, errors, map);
            } else if (testRegistrationBase instanceof Student) {
                validateStudent((Student) testRegistrationBase, errors, map);
            } else if (testRegistrationBase instanceof StudentGroup) {
                validateStudentGroup((StudentGroup) testRegistrationBase, errors, map);
            } else if (testRegistrationBase instanceof User) {
                validateUser((User) testRegistrationBase, errors, map);
            } else {
                throw new UnsupportedOperationException("Validation doesn't support this type of Sb11NonEntity.");
            }
        }
        return errors;
    }

    @SuppressWarnings("unchecked")
    private void validateUser(User user, List<FieldError> errors, Set<String> map) {
        Set<String> associatedEntityMongoIds = new HashSet<>();
        for (User.RoleAssociation roleAssociation : user.getRoleAssociations()) {
            if (roleAssociation.getAssociatedEntityMongoId() != null) {
                associatedEntityMongoIds.add(roleAssociation.getAssociatedEntityMongoId());
            } else if (roleAssociation.getAssociatedEntityId() != null
                    && roleAssociation.getStateAbbreviation() != null) {
                Sb11Entity sb11EntityLookup = null;
                if (Sb11SuperEntity.class.isAssignableFrom(roleAssociation.getLevel().getEntityClass())) {
                    sb11EntityLookup = sb11EntityService.findByEntityId(roleAssociation.getAssociatedEntityId(),
                            (Class<Sb11SuperEntity>) roleAssociation.getLevel().getEntityClass());
                } else {
                    String stateAbbrev = roleAssociation.getStateAbbreviation();
                    sb11EntityLookup = sb11EntityService.findByEntityIdAndStateAbbreviation(roleAssociation
                            .getAssociatedEntityId(), stateAbbrev, roleAssociation.getLevel().getEntityClass());
                }
                if (sb11EntityLookup != null) {
                    associatedEntityMongoIds.add(sb11EntityLookup.getId());
                }
            } else {
                LOGGER.warn("unable to find this role association's associated entity: " + roleAssociation.getLevel() + "," + roleAssociation.getAssociatedEntityId() + ", " + roleAssociation.getAssociatedEntityMongoId());
            }
        }

        for (String associatedEntityMongoId : associatedEntityMongoIds) {
            if (!map.contains(associatedEntityMongoId)) {
                addFieldError(errors, user, "---", "---", "Access Denied");
                return;
            }
        }
    }

    @SuppressWarnings("unchecked")
    private void validateSb11Entity(Sb11Entity sb11Entity, List<FieldError> errors, Set<String> map) {

        // check if we have access to this entity itself
        String mongoEntityId = sb11Entity.getId();
        Sb11Entity sb11EntityLookup = null;
        if (mongoEntityId == null) {
            if (sb11Entity instanceof Sb11SuperEntity) {
                sb11EntityLookup = sb11EntityService.findByEntityId(sb11Entity.getEntityId(),
                        (Class<Sb11SuperEntity>) sb11Entity.getEntityType().getEntityClass());
            } else {
                String stateAbbreviation = sb11Entity.getStateAbbreviation();
                sb11EntityLookup = sb11EntityService.findByEntityIdAndStateAbbreviation(sb11Entity.getEntityId(),
                        stateAbbreviation, sb11Entity.getEntityType().getEntityClass());
            }
            if (sb11EntityLookup != null) {
                mongoEntityId = sb11EntityLookup.getId();
            }
        }

        // check if we have access to this entity's parent
        String parentMongoEntityId = sb11Entity.getParentId();
        if (mongoEntityId == null) {
            if (parentMongoEntityId == null) {
                Sb11Entity parentEntityLookup;
                if (sb11Entity.getParentEntityType().getEntityClass().equals(Sb11SuperEntity.class)) {
                    parentEntityLookup = sb11EntityService.findByEntityId(sb11Entity.getParentEntityId(),
                            (Class<Sb11SuperEntity>) sb11Entity.getParentEntityType().getEntityClass());
                } else {
                    String stateAbbreviation = sb11Entity.getStateAbbreviation();
                    parentEntityLookup = sb11EntityService.findByEntityIdAndStateAbbreviation(sb11Entity
                            .getParentEntityId(), stateAbbreviation, sb11Entity.getParentEntityType().getEntityClass());
                }
                if (parentEntityLookup != null) {
                    parentMongoEntityId = parentEntityLookup.getId();
                }
            }
        }

        if (mongoEntityId == null && parentMongoEntityId == null) {
            addFieldError(errors, sb11Entity, "---", "---", "Access Denied: Unknown");
        } else {
            if (mongoEntityId != null && (map != null && !map.contains(mongoEntityId))) {
                addFieldError(errors, sb11Entity, "---", "---", "Access Denied");
            } else if (parentMongoEntityId != null && (map != null && !map.contains(parentMongoEntityId))) {
                addFieldError(errors, sb11Entity, "---", "---", "Access Denied: Parent Entity");
            }
        }
    }

    private void validateAccommodation(Accommodation accommodation, List<FieldError> errors, Set<String> map) {
        Student student = studentRepository.findByEntityIdAndStateAbbreviation(accommodation.getStudentId(),
                accommodation.getStateAbbreviation());
        validateStudent(student, errors, map);
    }

    private void validateExplicitEligibility(ExplicitEligibility explicitEligibility, List<FieldError> errors,
            Set<String> map) {
        String stateAbbreviation = explicitEligibility.getStateAbbreviation();
        String studentId = explicitEligibility.getStudentId();
        Student student = studentRepository.findByEntityIdAndStateAbbreviation(studentId, stateAbbreviation);
        validateStudent(student, errors, map);
        if (errors.size() == 0) {
            String districtMongoId = explicitEligibility.getResponsibleDistrictMongoId();
            String districtId = explicitEligibility.getResponsibleDistrictId();
            checkAccessToDistrict(districtMongoId, districtId, stateAbbreviation, errors, map, explicitEligibility);
        }
    }

    private void validateStudent(Student student, List<FieldError> errors, Set<String> map) {
        if (student != null) {
            String stateAbbreviation = student.getStateAbbreviation();
            String districtMongoId = student.getDistrictEntityMongoId();
            String districtId = student.getDistrictIdentifier();
            checkAccessToDistrict(districtMongoId, districtId, stateAbbreviation, errors, map, student);

            String institutionMongoId = student.getInstitutionEntityMongoId();
            String institutionId = student.getInstitutionIdentifier();
            checkAccessToInstitution(institutionMongoId, institutionId, stateAbbreviation, errors, map, student);
        }
    }

    private void validateStudentGroup(StudentGroup studentGroup, List<FieldError> errors, Set<String> map) {
        if (studentGroup != null) {
            String stateAbbreviation = studentGroup.getStateAbbreviation();
            String districtMongoId = studentGroup.getDistrictEntityMongoId();
            String districtId = studentGroup.getDistrictIdentifier();
            checkAccessToDistrict(districtMongoId, districtId, stateAbbreviation, errors, map, studentGroup);

            String institutionMongoId = studentGroup.getInstitutionEntityMongoId();
            String institutionId = studentGroup.getInstitutionIdentifier();
            checkAccessToInstitution(institutionMongoId, institutionId, stateAbbreviation, errors, map, studentGroup);
        }
    }

    // -----------------------------------------------------------------------------------------------

    private void checkAccessToDistrict(String districtMongoId, String districtId, String stateAbbreviation,
            List<FieldError> errors, Set<String> map, TestRegistrationBase testRegistrationBase) {
        if (districtMongoId == null) {
            DistrictEntity districtEntity = sb11EntityService.findByEntityIdAndStateAbbreviation(districtId,
                    stateAbbreviation, DistrictEntity.class);
            if (districtEntity != null) {
                districtMongoId = districtEntity.getId();
            }
        }
        if (districtMongoId != null && !map.contains(districtMongoId)) {
            addFieldError(errors, testRegistrationBase, "---", "---", "Access Denied: District");
        }
    }

    private void checkAccessToInstitution(String institutionMongoId, String institutionId, String stateAbbreviation,
            List<FieldError> errors, Set<String> map, TestRegistrationBase testRegistrationBase) {
        if (institutionMongoId == null) {
            InstitutionEntity institutionEntity = sb11EntityService.findByEntityIdAndStateAbbreviation(institutionId,
                    stateAbbreviation, InstitutionEntity.class);
            if (institutionEntity != null) {
                institutionMongoId = institutionEntity.getId();
            }
        }
        if (institutionMongoId == null || !map.contains(institutionMongoId)) {
            addFieldError(errors, testRegistrationBase, "---", "---", "Access Denied: Institution");
        }
    }

}