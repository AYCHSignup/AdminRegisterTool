/*******************************************************************************
 * Educational Online Test Delivery System
 * Copyright (c) 2013 American Institutes for Research
 * 
 * Distributed under the AIR Open Source License, Version 1.0
 * See accompanying file AIR-License-1_0.txt or at
 * http://www.smarterapp.org/documents/American_Institutes_for_Research_Open_Source_Software_License.pdf
 ******************************************************************************/
package org.opentestsystem.delivery.testadmin.service;

import static org.hamcrest.CoreMatchers.is;
import static org.junit.Assert.assertNotNull;
import static org.junit.Assert.assertThat;
import static org.springframework.test.util.ReflectionTestUtils.setField;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.HashSet;
import java.util.List;
import java.util.Set;
import java.util.TreeSet;

import javax.annotation.Resource;

import org.joda.time.DateTime;
import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.delivery.testadmin.domain.Status;
import org.opentestsystem.delivery.testadmin.domain.TestAdminReport;
import org.opentestsystem.delivery.testadmin.domain.TestStatus;
import org.opentestsystem.delivery.testadmin.domain.schedule.Schedule;
import org.opentestsystem.delivery.testadmin.domain.schedule.ScheduledDay;
import org.opentestsystem.delivery.testadmin.domain.schedule.ScheduledFacility;
import org.opentestsystem.delivery.testadmin.domain.schedule.ScheduledSeat;
import org.opentestsystem.delivery.testadmin.domain.schedule.ScheduledTimeSlot;
import org.opentestsystem.delivery.testadmin.persistence.ScheduleRepository;
import org.opentestsystem.delivery.testadmin.persistence.TestStatusRepository;
import org.opentestsystem.delivery.testreg.domain.Assessment;
import org.opentestsystem.delivery.testreg.domain.FormatType;
import org.opentestsystem.delivery.testreg.domain.InstitutionEntity;
import org.opentestsystem.delivery.testreg.domain.Student;
import org.opentestsystem.delivery.testreg.domain.TestRegistrationBase;
import org.opentestsystem.delivery.testreg.integration.AbstractPersistenceEmbeddedTest;
import org.opentestsystem.delivery.testreg.integration.eligibility.MockStudentRepository;
import org.opentestsystem.delivery.testreg.service.TestRegPersister;
import org.opentestsystem.shared.search.domain.AbstractSearchRequest;
import org.opentestsystem.shared.search.domain.SearchResponse;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;

public class StudentScheduleReportServiceTest extends AbstractPersistenceEmbeddedTest {

    private Schedule schedule;
    ScheduleRepository scheduleRepository;

    @Autowired
    TestStatusRepository studentTestRepository;

    @Resource(name = "studentScheduleReportService")
    private ScheduleReportService scheduleReportService;

    @Autowired
    TestRegPersister entityService;

    // ScheduleReportService scheduleReportService;

    @Before
    public void setup() {
        setField(scheduleReportService, "entityService", new MockEntityService());
        setField(scheduleReportService, "studentRepos", new MockStudentService());
        setField(scheduleReportService, "studentTestRepository", new MockTestStatusRepository());

        ScheduledSeat seat1 = new ScheduledSeat();
        ScheduledSeat seat2 = new ScheduledSeat();
        ScheduledSeat seat3 = new ScheduledSeat();

        Student student1 = new Student();
        student1.setEntityId("0001");
        student1.setFirstName("1FName");
        student1.setFirstName("1LName");
        student1.setMiddleName("A");
        student1.setStateAbbreviation("WI");
        student1.setExternalSsid("1FNameLName@edu.org");

        Student student2 = new Student();
        student1.setEntityId("0002");
        student2.setFirstName("2FName");
        student2.setFirstName("2LName");
        student2.setMiddleName("A");
        student2.setStateAbbreviation("WI");
        student2.setExternalSsid("2FNameLName@edu.org");
        Student student3 = new Student();
        student1.setEntityId("0003");
        student3.setFirstName("3FName");
        student3.setFirstName("3LName");
        student3.setMiddleName("A");
        student3.setExternalSsid("3FNameLName@edu.org");
        student3.setStateAbbreviation("WI");

        Assessment assessment1 = new Assessment();
        assessment1.setTestName("TEST1");
        assessment1.setTestLabel("TEST1-WI");
        assessment1.setId("53ff860fde0d39090ad54dc8");

        Assessment assessment2 = new Assessment();
        assessment2.setTestName("TEST2");
        assessment2.setTestLabel("TEST2-WI");
        assessment2.setId("53ff860fde0d39090ad54dc9");

        Assessment assessment3 = new Assessment();
        assessment3.setTestName("TEST3");
        assessment3.setTestLabel("TEST3-WI");
        assessment3.setId("53ff860fde0d39090ad54dd1");

        Set<ScheduledSeat> sets = new HashSet<ScheduledSeat>();
        seat1.setStudent(student1);
        seat1.setAssessment(assessment1);

        seat2.setStudent(student2);
        seat2.setAssessment(assessment2);

        seat3.setStudent(student3);
        seat3.setAssessment(assessment3);
        sets.add(seat1);
        sets.add(seat2);
        sets.add(seat3);

        ScheduledTimeSlot sts1 = new ScheduledTimeSlot();
        sts1.setStartTime(new DateTime(2014, 06, 01, 17, 0));
        sts1.setEndTime(new DateTime(2014, 06, 01, 18, 0));
        sts1.setSeats(sets);

        TreeSet<ScheduledTimeSlot> sts = new TreeSet<ScheduledTimeSlot>();
        sts.add(sts1);

        List<ScheduledDay> days = new ArrayList<ScheduledDay>();
        ScheduledDay scheduledDay = new ScheduledDay();
        scheduledDay.setDay(new DateTime(2014, 6, 1, 0, 0));

        ScheduledFacility scheduledFacility = new ScheduledFacility();
        scheduledFacility.setLocation("Madison West");
        scheduledFacility.setTimeSlots(sts);
        scheduledDay.setFacilities(Arrays.asList(new ScheduledFacility[] { scheduledFacility }));
        days.add(scheduledDay);

        // create schedule
        schedule = new Schedule();
        schedule.setStartDate(new DateTime(2014, 6, 1, 0, 0));
        schedule.setEndDate(new DateTime(2014, 6, 2, 0, 0));
        schedule.setInstitutionIdentifier("INS1");
        schedule.setScheduledDays(days);
        setField(scheduleReportService, "scheduleRepository", new MockScheduleRepository());

    }

    @Test
    public void testBuildProctorReport() {

        List<TestAdminReport> reports = scheduleReportService.buildScheduledReport("INS1", new DateTime(2014, 6, 1, 0,
                0), new DateTime(2014, 6, 2, 0, 0));
        assertNotNull(reports);
        assertThat(reports.size(), is(3));

    }

    public class MockScheduleRepository implements ScheduleRepository {

        @Override
        public SearchResponse<Schedule> search(AbstractSearchRequest arg0) {

            return null;
        }

        @Override
        public <S extends Schedule> List<S> save(Iterable<S> entites) {

            return null;
        }

        @Override
        public List<Schedule> findAll() {

            return null;
        }

        @Override
        public List<Schedule> findAll(Sort sort) {

            return null;
        }

        @Override
        public Page<Schedule> findAll(Pageable pageable) {

            return null;
        }

        @Override
        public <S extends Schedule> S save(S entity) {

            return null;
        }

        @Override
        public Schedule findOne(String id) {

            return null;
        }

        @Override
        public boolean exists(String id) {

            return false;
        }

        @Override
        public Iterable<Schedule> findAll(Iterable<String> ids) {

            return null;
        }

        @Override
        public long count() {

            return 0;
        }

        @Override
        public void delete(String id) {

        }

        @Override
        public void delete(Schedule entity) {

        }

        @Override
        public void delete(Iterable<? extends Schedule> entities) {

        }

        @Override
        public void deleteAll() {

        }

        @Override
        public Schedule findScheduleByFacilityAndStartDate(String institutionId, String facility, DateTime dateTime) {

            return null;

        }

        @Override
        public List<Schedule> findScheduleByStartDateAndEndDate(String institutionId, DateTime startDate,
                DateTime endDate) {
            if (institutionId.equals("INS1")) {
                return Arrays.asList(schedule);
            }
            return null;
        }

        @Override
        public Schedule findByScheduleName(String name) {

            return null;
        }

        @Override
        public Schedule updateScheduleDay(String scheduleId, ScheduledDay scheduledDay) {
            return null;
        }

        @Override
        public List<Schedule> findByInstitutionId(String institutionId) {
            // TODO Auto-generated method stub
            return null;
        }

    }

    private class MockEntityService implements TestRegPersister {

        private int saveCount = 0;
        private int updateCount = 0;
        private int deleteCount = 0;

        public int getSaveCount() {
            return saveCount;
        }

        public int getUpdateCount() {
            return updateCount;
        }

        public int getDeleteCount() {
            return deleteCount;
        }

        @SuppressWarnings("unused")
        public void resetCounts() {
            saveCount = 0;
            updateCount = 0;
            deleteCount = 0;
        }

        @SuppressWarnings("unchecked")
        @Override
        public <T extends TestRegistrationBase> T findById(String pkId, FormatType formatType) {
            InstitutionEntity entity = new InstitutionEntity();
            entity.setId("53ff860fde0d39090ad54dc7");
            return (T) entity;
        }

        @Override
        public <T extends TestRegistrationBase> List<T> findAll(FormatType formatType) {
            return null;
        }

        @Override
        public <T extends TestRegistrationBase> T saveDomainObject(T domainObj) {
            return null;
        }

        public <T extends TestRegistrationBase> T updateDomainObject(T domainObj) {
            return null;
        }

        @Override
        public <T extends TestRegistrationBase> void deleteDomainObject(T domainObj) {

        }

        @Override
        public <T extends TestRegistrationBase> void deleteDomainObject(String pkId, FormatType formatType) {

        }

        @Override
        public <T extends TestRegistrationBase> List<T> saveDomainObjects(List<T> domainObjList) {
            saveCount += domainObjList.size();

            return domainObjList;
        }

        @Override
        public <T extends TestRegistrationBase> List<T> updateDomainObjects(List<T> domainObjList) {
            updateCount += domainObjList.size();

            return domainObjList;
        }

        @Override
        public <T extends TestRegistrationBase> void deleteDomainObjects(List<T> domainObjList) {
            deleteCount += domainObjList.size();

        }

        @Override
        public <T extends TestRegistrationBase> SearchResponse<T> searchDomainObjects(
                AbstractSearchRequest searchRequest, FormatType formatType) {
            return null;
        }

        @Override
        public <T extends TestRegistrationBase> boolean hasAssociatedEntity(T domainObj) {
            return false;
        }

    }

    private class MockStudentService extends MockStudentRepository {

        public List<Student> findStudentsByInstitution(String institutionId) {
            List<Student> studentList = new ArrayList<Student>();
            Student student1 = new Student();
            student1.setEntityId("0001");
            student1.setFirstName("1FName");
            student1.setFirstName("1LName");
            student1.setMiddleName("A");
            student1.setStateAbbreviation("WI");
            student1.setExternalSsid("1FNameLName@edu.org");

            Student student2 = new Student();
            student2.setEntityId("0002");
            student2.setFirstName("2FName");
            student2.setFirstName("2LName");
            student2.setMiddleName("A");
            student2.setStateAbbreviation("WI");
            student2.setExternalSsid("2FNameLName@edu.org");
            Student student3 = new Student();
            student3.setEntityId("0003");
            student3.setFirstName("3FName");
            student3.setFirstName("3LName");
            student3.setMiddleName("A");
            student3.setExternalSsid("3FNameLName@edu.org");
            student3.setStateAbbreviation("WI");
            studentList.add(student1);
            studentList.add(student2);
            studentList.add(student3);
            return studentList;
        }

    }

    private class MockTestStatusRepository implements TestStatusRepository {

        @Override
        public SearchResponse<TestStatus> search(AbstractSearchRequest arg0) {
            // TODO Auto-generated method stub
            return null;
        }

        @Override
        public <S extends TestStatus> List<S> save(Iterable<S> entites) {
            // TODO Auto-generated method stub
            return null;
        }

        @Override
        public List<TestStatus> findAll() {
            // TODO Auto-generated method stub
            return null;
        }

        @Override
        public List<TestStatus> findAll(Sort sort) {
            // TODO Auto-generated method stub
            return null;
        }

        @Override
        public Page<TestStatus> findAll(Pageable pageable) {
            // TODO Auto-generated method stub
            return null;
        }

        @Override
        public <S extends TestStatus> S save(S entity) {
            // TODO Auto-generated method stub
            return null;
        }

        @Override
        public TestStatus findOne(String id) {
            // TODO Auto-generated method stub
            return null;
        }

        @Override
        public boolean exists(String id) {
            // TODO Auto-generated method stub
            return false;
        }

        @Override
        public Iterable<TestStatus> findAll(Iterable<String> ids) {
            // TODO Auto-generated method stub
            return null;
        }

        @Override
        public long count() {
            // TODO Auto-generated method stub
            return 0;
        }

        @Override
        public void delete(String id) {
            // TODO Auto-generated method stub

        }

        @Override
        public void delete(TestStatus entity) {
            // TODO Auto-generated method stub

        }

        @Override
        public void delete(Iterable<? extends TestStatus> entities) {
            // TODO Auto-generated method stub

        }

        @Override
        public void deleteAll() {
            // TODO Auto-generated method stub

        }

        @Override
        public List<TestStatus> findStudentReport(Collection<String> studentIdList, String stateAbbreviation,
                String assessmentId, int opportunity, String testStatus) {
            TestStatus status = new TestStatus();
            status.setStudentId("0001");
            status.setAssessmentId("53ff860fde0d39090ad54dc8");
            status.setStatus(Status.COMPLETED);
            status.setActualComplete(DateTime.now());
            return Arrays.asList(status);

        }

        @Override
        public TestStatus findByReportAlternateId(String studentId, String stateAbbreviation, String assessmentId,
                int opportunity) {
            // TODO Auto-generated method stub
            return null;
        }

        @Override
        public List<TestStatus> findByStudentIds(Collection<String> studentIds) {
            // TODO Auto-generated method stub
            return null;
        }

    }
}
