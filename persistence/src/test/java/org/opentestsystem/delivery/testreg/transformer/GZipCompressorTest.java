/*
Educational Online Test Delivery System Copyright (c) 2013 American Institutes for Research

Distributed under the AIR Open Source License, Version 1.0 See accompanying file AIR-License-1_0.txt or at
http://www.smarterapp.org/documents/American_Institutes_for_Research_Open_Source_Software_License.pdf
 */

package org.opentestsystem.delivery.testreg.transformer;

import static org.hamcrest.CoreMatchers.is;
import static org.junit.Assert.assertThat;
import static org.junit.Assert.fail;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.ArrayList;
import java.util.List;

import org.junit.Test;
import org.opentestsystem.delivery.testreg.integration.AbstractPersistenceEmbeddedTestDw;
import org.opentestsystem.delivery.testreg.transformer.domain.DwConfigs.DwConfigType;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.messaging.Message;

public class GZipCompressorTest extends AbstractPersistenceEmbeddedTestDw {

    @Autowired
    private GZipCompressor compressor;

    @Autowired
    private GzipUncompressor uncompressor;

    private static final String PLAINTEXT = "this is some test text";

    private static final Logger LOGGER = LoggerFactory.getLogger(GZipCompressorTest.class);

    private static final String UUID = "00000000-0000-0000-0000-000000000000";
    private static final String FILE_SUFFIX = "2014-01-01-000000000000";
    private static final int RECORDS = 10;

    @Test
    public void testCompress() {

        List<Path> filePaths = new ArrayList<Path>();

        File testFile = null;
        try {
            // testFile = File.createTempFile("tmp_plaintext_file_", "tmp");
            Path testFilePath = Files.createTempFile("tmp_plaintext_file_", "tmp");
            filePaths.add(testFilePath);
            testFile = testFilePath.toFile();
            FileWriter fw = new FileWriter(testFile);
            fw.write(PLAINTEXT);
            fw.flush();
            fw.close();
        } catch (IOException e1) {
            fail("failed to create a temp file");
        }

        Message<File> message = compressor.compressStream(testFile, UUID, FILE_SUFFIX, RECORDS, filePaths,
                DwConfigType.SBAC);

        File compressedFile = message.getPayload();

        // If you would like to verify the compressed bytes as a file,
        // uncomment the code below and add a file system path to output the compressed bytes to a file

        // FileOutputStream fout = null;
        //
        // try {
        // fout = new FileOutputStream("<file system path goes here>/testcompressed.gz");
        //
        // for (int i = 0; i < compressedbytes.length; i++) {
        // fout.write(compressedbytes[i]);
        // }
        //
        // fout.flush();
        // fout.close();
        //
        // } catch (IOException e1) {
        //
        // LOGGER.error("Failure to write file: " , e1);
        // }

        try {
            byte[] uncompressedBytes = uncompressor.uncompress(compressedFile);
            assertThat(new String(uncompressedBytes), is(PLAINTEXT));
        } catch (IOException e) {
            LOGGER.error("Failure to uncompress: ", e);
            fail("An exception was thrown while uncompressing and verifying");
        }

    }

}
