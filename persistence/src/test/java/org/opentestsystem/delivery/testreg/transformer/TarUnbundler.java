/*
Educational Online Test Delivery System Copyright (c) 2013 American Institutes for Research

Distributed under the AIR Open Source License, Version 1.0 See accompanying file AIR-License-1_0.txt or at
http://www.smarterapp.org/documents/American_Institutes_for_Research_Open_Source_Software_License.pdf
 */

package org.opentestsystem.delivery.testreg.transformer;

import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import org.apache.commons.compress.archivers.tar.TarArchiveEntry;
import org.apache.commons.compress.archivers.tar.TarArchiveInputStream;
import org.springframework.stereotype.Component;

/**
 * Test helper class used to unbundle a TAR stream.
 * 
 * Outputs a byte[][] where the output array is pairs of byte[] in which the first byte[] is a filename and the second
 * byte[] is the file contents.
 * 
 */
@Component
public class TarUnbundler {

    public byte[][] unbundle(File bundledFile) throws IOException {

        TarArchiveInputStream tarInputStream = new TarArchiveInputStream(new FileInputStream(bundledFile));
        List<byte[]> byteArrays = new ArrayList<byte[]>();
        ByteArrayOutputStream bytesOut = null;

        TarArchiveEntry entry = null;

        while ((entry = tarInputStream.getNextTarEntry()) != null) {

            byte[] buffer = new byte[4096];
            int len = 0;
            bytesOut = new ByteArrayOutputStream();

            while ((len = tarInputStream.read(buffer)) > 0) {
                bytesOut.write(buffer, 0, len);
            }

            byteArrays.add(entry.getName().getBytes());
            byteArrays.add(bytesOut.toByteArray());

            bytesOut.close();
        }

        tarInputStream.close();

        return byteArrays.toArray(new byte[0][]);
    }

}
