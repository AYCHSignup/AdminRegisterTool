/*******************************************************************************
 * Educational Online Test Delivery System
 * Copyright (c) 2013 American Institutes for Research
 * 
 * Distributed under the AIR Open Source License, Version 1.0
 * See accompanying file AIR-License-1_0.txt or at
 * http://www.smarterapp.org/documents/American_Institutes_for_Research_Open_Source_Software_License.pdf
 ******************************************************************************/

package org.opentestsystem.delivery.testreg.persistence.criteria.verifiers.studentgroup;

import static org.hamcrest.core.IsCollectionContaining.hasItem;
import static org.junit.Assert.assertThat;
import static org.opentestsystem.delivery.testreg.domain.FormatType.DISTRICT;
import static org.opentestsystem.delivery.testreg.domain.FormatType.INSTITUTION;
import static org.opentestsystem.delivery.testreg.domain.FormatType.STATE;
import static org.opentestsystem.delivery.testreg.domain.FormatType.STUDENT;
import static org.opentestsystem.delivery.testreg.domain.FormatType.STUDENTGROUP;
import static org.opentestsystem.delivery.testreg.domain.FormatType.USER;
import static org.springframework.test.util.ReflectionTestUtils.setField;

import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;

import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.delivery.testreg.domain.FormatType;
import org.opentestsystem.delivery.testreg.domain.StudentGroup;
import org.opentestsystem.delivery.testreg.domain.TestRegistrationBase;
import org.opentestsystem.delivery.testreg.persistence.Verifier;
import org.springframework.validation.FieldError;

public class StudentGroupVerifierChainTest {

    private Verifier<StudentGroup> verifier;
    List<String> invocationList;

    @SuppressWarnings("serial")
    @Before
    public void setup() {
        verifier = new StudentGroupVerifierChain();
        invocationList = new ArrayList<>();
        setField(
                verifier,
                "verifierMap",
                new HashMap<Class<? extends TestRegistrationBase>, HashMap<FormatType, Verifier<? extends TestRegistrationBase>>>() {
                    {
                        put(StudentGroup.class, new HashMap<FormatType, Verifier<? extends TestRegistrationBase>>() {
                            {
                                put(USER, new MockVerifier("userVerifierCalled"));
                                put(STATE, new MockVerifier("StateVerifierCalled"));
                                put(DISTRICT, new MockVerifier("DistrictVerifierCalled"));
                                put(INSTITUTION, new MockVerifier("InstitutionVerifierCalled"));
                                put(STUDENT, new MockVerifier("StudentVerifierCalled"));
                                put(STUDENTGROUP, new MockVerifier("maxStudentGroupVerifierCalled"));
                            }
                        });

                    }
                });
    }

    @Test
    public void testAllVerifiersCalled() {
        verifier.verify(new StudentGroup());
        assertThat(invocationList, hasItem("userVerifierCalled"));
        assertThat(invocationList, hasItem("StateVerifierCalled"));
        assertThat(invocationList, hasItem("InstitutionVerifierCalled"));
        assertThat(invocationList, hasItem("maxStudentGroupVerifierCalled"));
    }

    private class MockVerifier implements Verifier<StudentGroup> {

        private String flagToIdentifyInvocation;

        private MockVerifier(String flagToIdentifyInvocation) {
            this.flagToIdentifyInvocation = flagToIdentifyInvocation;
        }

        @Override
        public List<FieldError> verify(StudentGroup b) {
            invocationList.add(flagToIdentifyInvocation);
            return Collections.emptyList();
        }

    }
}
