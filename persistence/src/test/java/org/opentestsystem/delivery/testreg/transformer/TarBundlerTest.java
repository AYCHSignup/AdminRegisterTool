/*
Educational Online Test Delivery System Copyright (c) 2013 American Institutes for Research

Distributed under the AIR Open Source License, Version 1.0 See accompanying file AIR-License-1_0.txt or at
http://www.smarterapp.org/documents/American_Institutes_for_Research_Open_Source_Software_License.pdf
 */

package org.opentestsystem.delivery.testreg.transformer;

import static org.hamcrest.CoreMatchers.is;
import static org.junit.Assert.assertThat;
import static org.junit.Assert.fail;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.ArrayList;
import java.util.List;

import org.junit.Test;
import org.opentestsystem.delivery.testreg.integration.AbstractPersistenceEmbeddedTestDw;
import org.opentestsystem.delivery.testreg.transformer.domain.DwConfigs.DwConfigType;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.messaging.Message;

public class TarBundlerTest extends AbstractPersistenceEmbeddedTestDw {

    @Autowired
    private TarBundler tarBundler;

    @Autowired
    private TarUnbundler unbundler;

    private static final String PLAINTEXT = "this is some test text";
    private static final String PLAINTEXT_FILENAME = "test_text1.txt";

    private static final String PLAINTEXT_2 = "some more test text";
    private static final String PLAINTEXT_2_FILENAME = "test_text2.txt";

    private static final Logger LOGGER = LoggerFactory.getLogger(TarBundlerTest.class);

    private static final String UUID = "00000000-0000-0000-0000-000000000000";
    private static final String FILE_SUFFIX = "2014-01-01-000000000000";
    private static final int RECORDS = 10;

    @Test
    public void testTar() {

        List<Path> filePaths = new ArrayList<Path>();

        File testFile = null;
        File testFile2 = null;
        try {
            // testFile = File.createTempFile("tmp_plaintext_file_", "tmp");
            Path testFilePath = Files.createTempFile("tmp_plaintext_file_", "tmp");
            filePaths.add(testFilePath);
            testFile = testFilePath.toFile();
            FileWriter fw = new FileWriter(testFile);
            fw.write(PLAINTEXT);
            fw.flush();
            fw.close();

            // testFile2 = File.createTempFile("tmp_plaintext_file2_", "tmp");
            Path testFile2Path = Files.createTempFile("tmp_plaintext_file2_", "tmp");
            filePaths.add(testFile2Path);
            testFile2 = testFile2Path.toFile();
            fw = new FileWriter(testFile2);
            fw.write(PLAINTEXT_2);
            fw.flush();
            fw.close();
        } catch (IOException e1) {
            fail("failed to create a temp file");
        }

        String[] inputToTar = new String[6];
        inputToTar[0] = PLAINTEXT_FILENAME;
        inputToTar[1] = testFile.getAbsolutePath();
        inputToTar[2] = String.valueOf(testFile.length());

        inputToTar[3] = PLAINTEXT_2_FILENAME;
        inputToTar[4] = testFile2.getAbsolutePath();
        inputToTar[5] = String.valueOf(testFile2.length());

        Message<File> message = tarBundler.bundleToTar(inputToTar, UUID, FILE_SUFFIX, RECORDS, filePaths,
                DwConfigType.SBAC);

        File bundledFile = message.getPayload();

        // If you would like to verify the bundled bytes as a file,
        // uncomment the code below and add a file system path to output the bundled bytes to a file

        // FileOutputStream fout = null;
        //
        // try {
        // fout = new FileOutputStream("<path goes here>/testbundle.tar");
        //
        // for (int i = 0; i < bundledBytes.length; i++) {
        // fout.write(bundledBytes[i]);
        // }
        //
        // fout.flush();
        // fout.close();
        //
        // } catch (IOException e1) {
        //
        // LOGGER.error("Failure to create file: ", e1);
        // }

        try {
            byte[][] unbundledBytes = unbundler.unbundle(bundledFile);
            assertThat(new String(unbundledBytes[0]), is(PLAINTEXT_FILENAME));
            assertThat(new String(unbundledBytes[1]), is(PLAINTEXT));
            assertThat(new String(unbundledBytes[2]), is(PLAINTEXT_2_FILENAME));
            assertThat(new String(unbundledBytes[3]), is(PLAINTEXT_2));
        } catch (IOException e) {
            LOGGER.error("Failure to unbundle: ", e);
            fail("An exception was thrown while unbundling");
        }

    }

}
