/*******************************************************************************
 * Educational Online Test Delivery System
 * Copyright (c) 2013 American Institutes for Research
 * 
 * Distributed under the AIR Open Source License, Version 1.0
 * See accompanying file AIR-License-1_0.txt or at
 * http://www.smarterapp.org/documents/American_Institutes_for_Research_Open_Source_Software_License.pdf
 ******************************************************************************/

package org.opentestsystem.delivery.testreg.domain;

import static org.hamcrest.core.Is.is;
import static org.junit.Assert.assertThat;

import java.util.Set;

import javax.validation.ConstraintViolation;
import javax.validation.Validator;
import javax.validation.constraints.Size;

import org.junit.After;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.opentestsystem.delivery.testreg.domain.constraints.Alphanumeric;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;

@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(locations = { "classpath:spring/domain-context.xml", "classpath:test-domain-context.xml" })
public class AccommodationTest {

    public static final String STUDENTID_REQUIRED_MESSAGE = "Student Identifier is required";
    public static final String STUDENTID_ALPHANUM_MESSAGE = "Student Identifier should be alphanumeric";
    public static final String STUDENTID_MAX_MESSAGE = "Student Identifier size must be between 1 and 30";
    public static final String SUBJECT_REQUIRED_MESSAGE = "Subject is required";
    public static final String SUBJECT_ALPHANUM_MESSAGE = "Subject should be alphanumeric";
    public static final String SUBJECT_MAX_MESSAGE = "Subject size must be between 1 and 20";
    public static final String STATEABBR_REQUIRED_MESSAGE = "State Abbreviation is not valid";
    public static final String STATEABBR_INVALID_MESSAGE = "State Abbreviation is not valid";
    public static final String ASL_INVALID_MESSAGE = "Invalid value for American Sign Language accommodation";
    public static final String CC_INVALID_MESSAGE = "Invalid value for Closed Captioning accommodation";
    public static final String COLORCONTRAST_INVALID_MESSAGE = "Invalid value for Color Contrast accommodation";
    public static final String TEXTTOSPEECH_INVALID_MESSAGE = "Invalid value for Text to Speech accommodation";
    public static final String LANGUAGE_INVALID_MESSAGE = "Invalid value for Language accommodation";
    public static final String TRANSLATION_INVALID_MESSAGE = "Invalid value for Translation (Glossary) accommodation";
    public static final String PRINTONDEMAND_INVALID_MESSAGE = "Invalid value for Print on Demand accommodation";
    public static final String PRINTSIZE_INVALID_MESSAGE = "Invalid value for Print Size accommodation";
    public static final String MASKING_INVALID_MESSAGE = "Invalid value for Masking accommodation";
    public static final String PERMISSIVEMODE_INVALID_MESSAGE = "Invalid value for Permissive Mode accommodation";
    public static final String STREAMLINED_INVALID_MESSAGE = "Invalid value for Streamlined Interface accommodation";
    public static final String DESIGSUPPORTS_INVALID_MESSAGE = "Invalid value for Non-embedded Designated Supports accommodation";
    public static final String NONEMBEDDED_INVALID_MESSAGE = "Invalid value for Non-embedded Accommodations";
    public static final String OTHER_INVALID_MESSAGE = "Valid values for Other accommodation are alphanumeric characters, spaces, dashes, and periods";
    public static final String OTHER_MAX_MESSAGE = "Maximum length for Other accommodation is 300 characters";
    public static final String AT_LEAST_ONE_ACCOMM_SELECTED = "At least one Accommodation is required to be selected";

    @Autowired
    protected Validator validator;

    private Accommodation accommodation;

    @Before
    public void setup() {
        accommodation = new Accommodation();
    }

    @After
    public void tearDown() {
        accommodation = null;
    }

    @Test
    public void testBlankOrNullStudentIdentifier() {
        accommodation.setStudentId(null);
        assertBlankOrNullCheck(accommodation, "studentId", STUDENTID_REQUIRED_MESSAGE);
        accommodation.setStudentId("");
        assertBlankOrNullCheck(accommodation, "studentId", STUDENTID_REQUIRED_MESSAGE);
        accommodation.setStudentId("   ");
        assertBlankOrNullCheck(accommodation, "studentId", STUDENTID_REQUIRED_MESSAGE);
    }

    @Test
    public void testStudentIdentifierUnicodeInvalid() {
        accommodation.setStudentId("Specialcharsẘ✹⚅☈");
        Set<ConstraintViolation<Accommodation>> constraintViolations = validator.validateProperty(accommodation,
                "studentId");
        assertThat(constraintViolations.size(), is(1));
        assertThat(constraintViolations.iterator().next().getMessage(), is(STUDENTID_ALPHANUM_MESSAGE));

    }

    @Test
    public void testSizeForaccommodationIdentifier() {
        accommodation.setStudentId("126627626726GGHGHg77277367882378ywsjkbjwe773899qq");
        Set<ConstraintViolation<Accommodation>> constraintViolations = validator.validateProperty(accommodation,
                "studentId");
        assertThat(constraintViolations.size(), is(1));
        accommodation.setStudentId("12662762aa");
        constraintViolations = validator.validateProperty(accommodation, "studentId");
        assertThat(constraintViolations.size(), is(0));
    }

    @Test
    public void testInvalidStateAbbreviation() {
        accommodation.setStateAbbreviation("BC");
        assertInvalidStateAbbreviation("stateAbbreviation");
        accommodation.setStateAbbreviation("nmn");
        assertInvalidStateAbbreviation("stateAbbreviation");
        accommodation.setStateAbbreviation("--");
        assertInvalidStateAbbreviation("stateAbbreviation");
        accommodation.setStateAbbreviation("$$"); // special characters
        assertInvalidStateAbbreviation("stateAbbreviation");
        accommodation.setStateAbbreviation("æ♪"); // non-ascii
        assertInvalidStateAbbreviation("stateAbbreviation");
    }

    @Test
    public void testBlankOrNullSubject() {
        accommodation.setSubject(null);
        assertBlankOrNullCheck(accommodation, "subject", SUBJECT_REQUIRED_MESSAGE);
        accommodation.setSubject("");
        assertBlankOrNullCheck(accommodation, "subject", SUBJECT_REQUIRED_MESSAGE);
        accommodation.setSubject("   ");
        assertBlankOrNullCheck(accommodation, "subject", SUBJECT_REQUIRED_MESSAGE);
    }

    @Test
    public void testSubjectUnicodeInvalid() {
        accommodation.setSubject("Specialcharsẘ✹⚅☈");
        Set<ConstraintViolation<Accommodation>> constraintViolations = validator.validateProperty(accommodation,
                "subject");
        assertThat(constraintViolations.size(), is(1));
        assertThat(constraintViolations.iterator().next().getMessage(), is(SUBJECT_ALPHANUM_MESSAGE));

    }

    @Test
    public void testSizeForSubject() {
        accommodation.setSubject("126627626726GGHGHg77277367882378ywsjkbjwe773899qq");
        Set<ConstraintViolation<Accommodation>> constraintViolations = validator.validateProperty(accommodation,
                "subject");
        assertThat(constraintViolations.size(), is(1));
        accommodation.setSubject("12662762aa");
        constraintViolations = validator.validateProperty(accommodation, "subject");
        assertThat(constraintViolations.size(), is(0));
    }

    @Test
    public void testInvalidLanguageCodes() {

        accommodation.setLanguage("BCA");
        assertInvalidPropertyCheck(accommodation, "language", LANGUAGE_INVALID_MESSAGE);
        accommodation.setLanguage("ABC");
        assertInvalidPropertyCheck(accommodation, "language", LANGUAGE_INVALID_MESSAGE);

    }

    @Test
    public void testValidLanguageCodes() {
        accommodation.setLanguage("ENU");
        Set<ConstraintViolation<Accommodation>> constraintViolations = validator.validateProperty(accommodation,
                "language");
        assertThat(constraintViolations.size(), is(0));
        accommodation.setLanguage("ENU-Braille");
        constraintViolations = validator.validateProperty(accommodation, "language");
        assertThat(constraintViolations.size(), is(0));
        accommodation.setLanguage("ESN");
        constraintViolations = validator.validateProperty(accommodation, "language");
        assertThat(constraintViolations.size(), is(0));
    }

    @Test
    public void testInvalidAmericanSignLanguage() {

        accommodation.setAmericanSignLanguage("ENG");
        assertInvalidPropertyCheck(accommodation, "americanSignLanguage", ASL_INVALID_MESSAGE);
        accommodation.setAmericanSignLanguage("SPN");
        assertInvalidPropertyCheck(accommodation, "americanSignLanguage", ASL_INVALID_MESSAGE);

    }

    @Test
    public void testValidAmericanSignLanguage() {
        accommodation.setAmericanSignLanguage("TDS_ASL0");
        Set<ConstraintViolation<Accommodation>> constraintViolations = validator.validateProperty(accommodation,
                "americanSignLanguage");
        assertThat(constraintViolations.size(), is(0));
        accommodation.setAmericanSignLanguage("TDS_ASL1");
        constraintViolations = validator.validateProperty(accommodation, "americanSignLanguage");
        assertThat(constraintViolations.size(), is(0));
    }

    @Test
    public void testInvalidClosedCaptioning() {

        accommodation.setClosedCaptioning("TDS");
        assertInvalidPropertyCheck(accommodation, "closedCaptioning", CC_INVALID_MESSAGE);
        accommodation.setClosedCaptioning("ClosedO");
        assertInvalidPropertyCheck(accommodation, "closedCaptioning", CC_INVALID_MESSAGE);

    }

    @Test
    public void testValidClosedCaptioning() {
        accommodation.setClosedCaptioning("TDS_ClosedCap0");
        Set<ConstraintViolation<Accommodation>> constraintViolations = validator.validateProperty(accommodation,
                "closedCaptioning");
        assertThat(constraintViolations.size(), is(0));
        accommodation.setClosedCaptioning("TDS_ClosedCap1");
        constraintViolations = validator.validateProperty(accommodation, "closedCaptioning");
        assertThat(constraintViolations.size(), is(0));
    }

    @Test
    public void testInvalidColorContrast() {

        accommodation.setColorContrast("TDS");
        assertInvalidPropertyCheck(accommodation, "colorContrast", COLORCONTRAST_INVALID_MESSAGE);
        accommodation.setColorContrast("ClosedO");
        assertInvalidPropertyCheck(accommodation, "colorContrast", COLORCONTRAST_INVALID_MESSAGE);

    }

    @Test
    public void testValidColorContrast() {

        String[] coloChoices = { "TDS_CCMagenta", "TDS_CCMedGrayLtGray", "TDS_CCYellowB", "TDS_CCInvert", "TDS_CC0" };
        for (int i = 0; i < coloChoices.length; i++) {
            accommodation.setColorContrast(coloChoices[i]);
            assertThat(validator.validateProperty(accommodation, "colorContrast").size(), is(0));

        }
    }

    @Test
    public void testInvalidTexttoSpeech() {

        accommodation.setTextToSpeech("TDS");
        assertInvalidPropertyCheck(accommodation, "textToSpeech", TEXTTOSPEECH_INVALID_MESSAGE);
        accommodation.setTextToSpeech("TTS");
        assertInvalidPropertyCheck(accommodation, "textToSpeech", TEXTTOSPEECH_INVALID_MESSAGE);
    }

    @Test
    public void testValidTexttoSpeech() {

        String[] textChoice = { "TDS_TTS_Stim&TDS_TTS_Item", "TDS_TTS_Item", "TDS_TTS_Stim", "TDS_TTS0" };
        for (int i = 0; i < textChoice.length; i++) {
            accommodation.setTextToSpeech(textChoice[i]);
            assertThat(validator.validateProperty(accommodation, "textToSpeech").size(), is(0));
        }

    }

    @Test
    public void testInvalidTranslation() {

        accommodation.setTranslation("TDS");
        assertInvalidPropertyCheck(accommodation, "translation", TRANSLATION_INVALID_MESSAGE);
        accommodation.setTranslation("TTS");
        assertInvalidPropertyCheck(accommodation, "translation", TRANSLATION_INVALID_MESSAGE);

    }

    @Test
    public void testValidTranslation() {

        String[] glossary = { "TDS_WL_Glossary", "TDS_WL_ArabicGloss", "TDS_WL_CantoneseGloss", "TDS_WL_ESNGlossary",
                "TDS_WL_KoreanGloss", "TDS_WL_MandarinGloss", "TDS_WL_PunjabiGloss", "TDS_WL_RussianGloss",
                "TDS_WL_TagalGloss", "TDS_WL_UkrainianGloss", "TDS_WL_VietnameseGloss",
                "TDS_WL_Glossary&TDS_WL_ArabicGloss", "TDS_WL_Glossary&TDS_WL_CantoneseGloss",
                "TDS_WL_Glossary&TDS_WL_ESNGlossary", "TDS_WL_Glossary&TDS_WL_KoreanGloss",
                "TDS_WL_Glossary&TDS_WL_MandarinGloss", "TDS_WL_Glossary&TDS_WL_PunjabiGloss",
                "TDS_WL_Glossary&TDS_WL_RussianGloss", "TDS_WL_Glossary&TDS_WL_TagalGloss",
                "TDS_WL_Glossary&TDS_WL_UkrainianGloss", "TDS_WL_Glossary&TDS_WL_VietnameseGloss", "TDS_WL0" };
        for (int i = 0; i < glossary.length; i++) {
            accommodation.setTranslation(glossary[i]);
            assertThat(validator.validateProperty(accommodation, "translation").size(), is(0));
        }

    }

    @Test
    public void testInvalidPrintOnDemand() {

        accommodation.setPrintOnDemand("TDS");
        assertInvalidPropertyCheck(accommodation, "printOnDemand", PRINTONDEMAND_INVALID_MESSAGE);
        accommodation.setPrintOnDemand("TTS");
        assertInvalidPropertyCheck(accommodation, "printOnDemand", PRINTONDEMAND_INVALID_MESSAGE);

    }

    @Test
    public void testValidPrintOnDemand() {

        String[] glossary = { "TDS_PoD_Stim", "TDS_PoD0" };
        for (int i = 0; i < glossary.length; i++) {
            accommodation.setPrintOnDemand(glossary[i]);
            assertThat(validator.validateProperty(accommodation, "printOnDemand").size(), is(0));
        }

    }

    @Test
    public void testInvalidPrintSize() {

        accommodation.setPrintSize("TDS");
        assertInvalidPropertyCheck(accommodation, "printSize", PRINTSIZE_INVALID_MESSAGE);
        accommodation.setPrintSize("TTS");
        assertInvalidPropertyCheck(accommodation, "printSize", PRINTSIZE_INVALID_MESSAGE);

    }

    @Test
    public void testValidPrintSize() {

        String[] glossary = { "TDS_PS_L0", "TDS_PS_L1", "TDS_PS_L2", "TDS_PS_L3", "TDS_PS_L4" };
        for (int i = 0; i < glossary.length; i++) {
            accommodation.setPrintSize(glossary[i]);
            assertThat(validator.validateProperty(accommodation, "printSize").size(), is(0));
        }

    }

    @Test
    public void testInvalidPermissiveMode() {

        accommodation.setPermissiveMode("TDS");
        assertInvalidPropertyCheck(accommodation, "permissiveMode", PERMISSIVEMODE_INVALID_MESSAGE);
        accommodation.setPermissiveMode("TTS");
        assertInvalidPropertyCheck(accommodation, "permissiveMode", PERMISSIVEMODE_INVALID_MESSAGE);

    }

    @Test
    public void testValidPermissiveMode() {

        String[] choices = { "TDS_PM0", "TDS_PM1" };
        for (int i = 0; i < choices.length; i++) {
            accommodation.setPermissiveMode(choices[i]);
            assertThat(validator.validateProperty(accommodation, "permissiveMode").size(), is(0));
        }

    }

    @Test
    public void testInvalidStreamlinedInterface() {

        accommodation.setStreamlinedInterface("TDS");
        assertInvalidPropertyCheck(accommodation, "streamlinedInterface", STREAMLINED_INVALID_MESSAGE);
        accommodation.setStreamlinedInterface("TTS");
        assertInvalidPropertyCheck(accommodation, "streamlinedInterface", STREAMLINED_INVALID_MESSAGE);

    }

    @Test
    public void testValidStreamlinedInterface() {

        String[] choices = { "TDS_TS_Modern", "TDS_TS_Accessibility" };
        for (int i = 0; i < choices.length; i++) {
            accommodation.setStreamlinedInterface(choices[i]);
            assertThat(validator.validateProperty(accommodation, "streamlinedInterface").size(), is(0));
        }

    }

    @Test
    public void testInvalidNonEmbeddedDesignatedSupports() {

        accommodation.setNonEmbeddedDesignatedSupports("TDS");
        assertInvalidPropertyCheck(accommodation, "nonEmbeddedDesignatedSupports", DESIGSUPPORTS_INVALID_MESSAGE);
        accommodation.setNonEmbeddedDesignatedSupports("TTS");
        assertInvalidPropertyCheck(accommodation, "nonEmbeddedDesignatedSupports", DESIGSUPPORTS_INVALID_MESSAGE);

    }

    @Test
    public void testValidNonEmbeddedDesignatedSupports() {

        String[] choices = { "NEDS0", "NEDS_BD", "NEDS_CC", "NEDS_CO", "NEDS_Mag", "NEDS_RA_Items", "NEDS_SC_Items",
                "NEDS_SS", "NEDS_TArabic", "NEDS_TCantonese", "NEDS_TFilipino", "NEDS_TKorean", "NEDS_TMandarin",
                "NEDS_TPunjabi", "NEDS_TRussian", "NEDS_TSpanish", "NEDS_TUkrainian", "NEDS_TVietnamese" };
        for (int i = 0; i < choices.length; i++) {
            accommodation.setNonEmbeddedDesignatedSupports(choices[i]);
            assertThat(validator.validateProperty(accommodation, "nonEmbeddedDesignatedSupports").size(), is(0));
        }

    }

    @Test
    public void testInvalidNonEmbeddedAccommodations() {

        accommodation.setNonEmbeddedAccommodations("TDS");
        assertInvalidPropertyCheck(accommodation, "nonEmbeddedAccommodations", NONEMBEDDED_INVALID_MESSAGE);
        accommodation.setNonEmbeddedAccommodations("TTS");
        assertInvalidPropertyCheck(accommodation, "nonEmbeddedAccommodations", NONEMBEDDED_INVALID_MESSAGE);

    }

    @Test
    public void testValidNonEmbeddedAccommodations() {

        String[] choices = { "NEA0", "NEA_AR", "NEA_RA_Stimuli", "NEA_SC_WritItems", "NEA_STT", "NEA_Abacus",
                "NEA_Calc", "NEA_MT" };
        for (int i = 0; i < choices.length; i++) {
            accommodation.setNonEmbeddedAccommodations(choices[i]);
            assertThat(validator.validateProperty(accommodation, "nonEmbeddedAccommodations").size(), is(0));
        }

    }

    @Alphanumeric(dashesAllowed = true, decimalAllowed = true, spacesAllowed = true, message = "{accommodation.other.invalid}")
    @Size(max = 300, message = "{accommodation.other.size.max}")
    @FieldLabel("Other")
    // @XStreamAlias("unknown")
    private String other;

    @Test
    public void testOtherTooLong() {

        accommodation
                .setOther("this is a very very long string used to test out the maximum length of the other field in an accommodations object this can be up to 300 characters long so we still have a long way to go at this point can we get all the way to 300 characters we will see not too certain at this point oh wait we did it");
        Set<ConstraintViolation<Accommodation>> constraintViolations = validator.validateProperty(accommodation,
                "other");
        assertThat(constraintViolations.size(), is(1));
        assertThat(constraintViolations.iterator().next().getMessage(), is(OTHER_MAX_MESSAGE));
    }

    @Test
    public void testDeleteInvalidWithSpecialChars() {
        accommodation.setOther("this should be ! invalid %");
        Set<ConstraintViolation<Accommodation>> constraintViolations = validator.validateProperty(accommodation,
                "other");

        assertThat(constraintViolations.size(), is(1));
        assertThat(constraintViolations.iterator().next().getMessage(), is(OTHER_INVALID_MESSAGE));

    }

    @Test
    public void testValidOther() {
        Set<ConstraintViolation<Accommodation>> constraintViolations = validator.validateProperty(accommodation,
                "other");
        assertThat(constraintViolations.size(), is(0));
    }

    @Test
    public void testValidaccommodation() {
        accommodation.setStudentId("110AA");
        accommodation.setStateAbbreviation("WI");
        accommodation.setSubject("MATH");
        accommodation.setAmericanSignLanguage("TDS_ASL0");
        accommodation.setClosedCaptioning("TDS_ClosedCap1");
        accommodation.setColorContrast("TDS_CCYellowB");
        accommodation.setTextToSpeech("TDS_TTS_Item");
        accommodation.setLanguage("ENU");
        accommodation.setTranslation("TDS_WL_ILOGlossary");
        accommodation.setPrintOnDemand("TDS_PoD0");
        accommodation.setPrintSize("TDS_PS_L1");
    }

    private void assertInvalidPropertyCheck(Accommodation accommodation, String property, String message) {
        Set<ConstraintViolation<Accommodation>> constraintViolations = validator.validateProperty(accommodation,
                property);
        assertThat(constraintViolations.size(), is(1));
        assertThat(constraintViolations.iterator().next().getMessage(), is(message));
    }

    private void assertBlankOrNullCheck(Accommodation accommodation, String property, String message) {
        Set<ConstraintViolation<Accommodation>> constraintViolations = validator.validateProperty(accommodation,
                property);
        assertThat(constraintViolations.size(), is(1));
        assertThat(constraintViolations.iterator().next().getMessage(), is(message));
    }

    // State Abbreviation Validations
    protected void assertInvalidStateAbbreviation(String property) {
        Set<ConstraintViolation<Accommodation>> constraintViolations = validator.validateProperty(accommodation,
                property);
        assertThat(constraintViolations.size(), is(1));
        assertThat(constraintViolations.iterator().next().getMessage(), is(STATEABBR_INVALID_MESSAGE));
    }

    @Test
    public void testValidStateAbbreviation() {
        accommodation.setStateAbbreviation("WI");
        Set<ConstraintViolation<Accommodation>> constraintViolations = validator.validateProperty(accommodation,
                "stateAbbreviation");
        assertThat(constraintViolations.size(), is(0));
    }

    @Test
    public void testAtLeastOneSelected() {
        accommodation.setStateAbbreviation("WI");
        accommodation.setSubject("MTH");
        accommodation.setStudentId("111");

        Set<ConstraintViolation<Accommodation>> constraintViolations = validator.validate(accommodation);
        assertThat(constraintViolations, org.hamcrest.Matchers.hasSize(1));
        assertThat(constraintViolations.iterator().next().getMessage(), is(AT_LEAST_ONE_ACCOMM_SELECTED));
    }

}
