/*******************************************************************************
 * Educational Online Test Delivery System
 * Copyright (c) 2013 American Institutes for Research
 * 
 * Distributed under the AIR Open Source License, Version 1.0
 * See accompanying file AIR-License-1_0.txt or at
 * http://www.smarterapp.org/documents/American_Institutes_for_Research_Open_Source_Software_License.pdf
 ******************************************************************************/
package org.opentestsystem.delivery.testadmin.domain;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.List;

import javax.validation.Valid;
import javax.validation.constraints.NotNull;
import javax.validation.constraints.Size;

import org.apache.commons.collections.CollectionUtils;
import org.apache.commons.lang.RandomStringUtils;
import org.hibernate.validator.constraints.NotBlank;
import org.hibernate.validator.constraints.NotEmpty;
import org.joda.time.DateTime;
import org.opentestsystem.delivery.testadmin.domain.Facility.SeatConfiguration;
import org.opentestsystem.delivery.testadmin.domain.constraints.ValidFacilityAvailabilityDate;
import org.opentestsystem.delivery.testreg.domain.constraints.Alphanumeric;
import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.mapping.Document;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import com.fasterxml.jackson.annotation.JsonProperty;

@Document
@JsonIgnoreProperties(ignoreUnknown = true)
@ValidFacilityAvailabilityDate
public class FacilityAvailability implements TestAdminBase {

    private static final long serialVersionUID = -7637255997529927194L;

    private static final String GET_RESOURCE_NAME = "/facilityAvailability/";

    @Id
    private String id;

    private String facilityId;

    @NotBlank(message = "{facilityavailability.name.blank}")
    @Alphanumeric(message = "{facilityavailability.name.alphanumeric}")
    private String facilityName;

    @NotBlank(message = "{facilityavailability.institutionidentifier.blank}")
    @Alphanumeric(message = "{facilityavailability.institutionidentifier.alphanumeric}")
    @Size(max = 40, message = "{facilityavailability.institutionidentifier.size.max}")
    private String institutionIdentifier;

    private String institutionId;

    @NotNull(message = "{facilityavailability.fromdate.blank}")
    private DateTime fromDate;

    @NotNull(message = "{facilityavailability.todate.blank}")
    private DateTime toDate;

    @NotEmpty(message = "{facilityavailability.facilitytimes.empty}")
    @Valid
    private List<FacilityTimeSlot> facilityTimes;

    @NotNull(message = "{facilityavailability.availability.blank}")
    private Availability status;

    public String getId() {
        return id;
    }

    public void setId(String id) {
        this.id = id;
    }

    public String getFacilityName() {
        return facilityName;
    }

    public void setFacilityName(String facilityName) {
        this.facilityName = facilityName;
    }

    public String getFacilityId() {
        return facilityId;
    }

    public void setFacilityId(String facilityId) {
        this.facilityId = facilityId;
    }

    public String getInstitutionIdentifier() {
        return institutionIdentifier;
    }

    public String getInstitutionId() {
        return institutionId;
    }

    public void setInstitutionId(String institutionId) {
        this.institutionId = institutionId;
    }

    public void setInstitutionIdentifier(String institutionIdentifier) {
        this.institutionIdentifier = institutionIdentifier;
    }

    public DateTime getFromDate() {
        return fromDate;
    }

    public void setFromDate(DateTime fromDate) {
        this.fromDate = fromDate;
    }

    public DateTime getToDate() {
        return toDate;
    }

    public void setToDate(DateTime toDate) {
        this.toDate = toDate;
    }

    public List<FacilityTimeSlot> getFacilityTimes() {
        return facilityTimes;
    }

    public void setFacilityTimes(List<FacilityTimeSlot> facilityTimes) {
        this.facilityTimes = facilityTimes;
    }

    public Availability getStatus() {
        return status;
    }

    public void setStatus(Availability status) {
        this.status = status;
    }

    public String getAvailability() {
       return this.status.toString();
    }
    
    /**
     * Defines facility availability/unavailability and testing slots
     * 
     */
    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class FacilityTimeSlot implements Serializable {

        private static final long serialVersionUID = -1450185936207802443L;

        @Valid
        private TimeSlot timeSlot;

        private List<SeatConfiguration> seatConfigurations;
        
        public FacilityTimeSlot() {
            this(null , null);
        }
        
        public FacilityTimeSlot(TimeSlot timeSlot, List<SeatConfiguration> seatConfigurations) {
            this.seatConfigurations = seatConfigurations;
            this.timeSlot = timeSlot;
        }

        public TimeSlot getTimeSlot() {
            return timeSlot;
        }

        public void setTimeSlot(TimeSlot timeSlot) {
            this.timeSlot = timeSlot;
        }

        public List<SeatConfiguration> getSeatConfigurations() {
            return seatConfigurations;
        }

        public void setSeatConfigurations(List<SeatConfiguration> seatConfigurations) {
            this.seatConfigurations = seatConfigurations;
        }

        public void createSeatsFromConfiguration() {
            int seatNumber = 0;
            if (CollectionUtils.isNotEmpty(seatConfigurations)) {
                for (SeatConfiguration config : seatConfigurations) {
                    List<Seat> seats = new ArrayList<Seat>();
                    for (int i = 0; i < config.getNumberOfSeats(); i++) {
                        Seat seat = new Seat(++seatNumber, config.getTestPlatform(),
                                config.getAccessibilityEquipments());
                        seats.add(seat);
                    }
                    config.setSeats(seats);
                    config.setConfigId(RandomStringUtils.randomAlphanumeric(16));
                }
            }
        }

    }

    @JsonProperty
    public String getUrl() {
        return GET_RESOURCE_NAME + this.id;
    }
}
