/*******************************************************************************
 * Educational Online Test Delivery System
 * Copyright (c) 2013 American Institutes for Research
 * 
 * Distributed under the AIR Open Source License, Version 1.0
 * See accompanying file AIR-License-1_0.txt or at
 * http://www.smarterapp.org/documents/American_Institutes_for_Research_Open_Source_Software_License.pdf
 ******************************************************************************/

package org.opentestsystem.delivery.testadmin.domain.constraintvalidators;

import static org.opentestsystem.delivery.testadmin.domain.constraintvalidators.ConstraintValidatorUtils.addPropertyNodes;

import java.util.ArrayList;
import java.util.Comparator;
import java.util.List;
import java.util.Set;
import java.util.TreeSet;

import javax.validation.ConstraintValidator;
import javax.validation.ConstraintValidatorContext;

import org.joda.time.Interval;
import org.opentestsystem.delivery.testadmin.domain.DateWindow;
import org.opentestsystem.delivery.testadmin.domain.DateWindowable;
import org.opentestsystem.delivery.testadmin.domain.constraints.OverlappingAvailabilityWindow;
import org.springframework.beans.factory.annotation.Autowired;

public class OverlappingAvailabilityWindowValidator implements ConstraintValidator<OverlappingAvailabilityWindow, DateWindowable> {
    
    @Autowired
    private DuplicateWindowValidationUtil duplicateWindowValidationUtil;
    
    private static final Comparator<Interval> INTERVAL_OVERLAP_COMPARATOR = new IntervalOverlapComparator();
           
    String node;
    
    @Override
    public void initialize(OverlappingAvailabilityWindow constraintAnnotation) {
        node = constraintAnnotation.node();
     }

    @Override
    public boolean isValid(DateWindowable dateWindowable, ConstraintValidatorContext context) {
        boolean isValid = true;
        
        if(!duplicateWindowValidationUtil.hasDuplicateWindows(dateWindowable)) {
            Set<Interval> intervalOverlapSet  = new TreeSet<Interval>(INTERVAL_OVERLAP_COMPARATOR);
            
            List<Interval> intervals = getIntervals(dateWindowable.getDateWindows());
            
            context.disableDefaultConstraintViolation();            
            for(int i=0; i< intervals.size(); i++) {
                Interval interval = intervals.get(i);
                if(!intervalOverlapSet.add(interval)) {
                    isValid = false;
                    addPropertyNodes(context, node)
                        .inIterable().atIndex(i)
                        .addConstraintViolation();
                }
            }      
        }        
        return isValid;
    }
    
    private List<Interval> getIntervals(List<DateWindow> dateWindowList) {
        List<Interval> list = new ArrayList<>();
        
        for(DateWindow dateWindow: dateWindowList) {
            if(haveValidDates(dateWindow)) {
                list.add(new Interval(dateWindow.getStartDateTime(), dateWindow.getEndDateTime()));
            }
        }
        return list;
    }
    
    private static class IntervalOverlapComparator implements Comparator<Interval> {

        @Override
        public int compare(Interval o1, Interval o2) {
            if(o1.overlaps(o2)) return 0;
            else return 1;
        }
        
    }
    
    private boolean haveValidDates(DateWindow windowObj) {
        if(windowObj.getEndDateTime() ==null) return false;
        return !windowObj.getEndDateTime().isBefore(windowObj.getStartDateTime());
    }

}
