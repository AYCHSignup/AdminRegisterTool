/*
Educational Online Test Delivery System Copyright (c) 2013 American Institutes for Research

Distributed under the AIR Open Source License, Version 1.0 See accompanying file AIR-License-1_0.txt or at
http://www.smarterapp.org/documents/American_Institutes_for_Research_Open_Source_Software_License.pdf
 */

package org.opentestsystem.delivery.testreg.domain;

import static org.apache.commons.lang.StringUtils.isNotEmpty;
import static org.apache.commons.lang.StringUtils.trim;

import java.util.HashMap;
import java.util.Map;

import javax.validation.constraints.Size;

import org.apache.commons.lang.builder.ToStringBuilder;
import org.apache.commons.lang.builder.ToStringStyle;
import org.hibernate.validator.constraints.NotBlank;
import org.opentestsystem.delivery.testreg.domain.constraints.Alpha;
import org.opentestsystem.delivery.testreg.domain.constraints.Alphanumeric;
import org.opentestsystem.delivery.testreg.domain.constraints.Ascii;
import org.opentestsystem.delivery.testreg.domain.constraints.Numeric;
import org.opentestsystem.delivery.testreg.domain.constraints.ValidParentEntityType;
import org.opentestsystem.delivery.testreg.domain.constraints.ValidParentExternalId;
import org.opentestsystem.delivery.testreg.domain.constraints.ValidStateCode;
import org.opentestsystem.delivery.testreg.domain.search.DistrictEntitySearchRequest;
import org.opentestsystem.shared.progman.client.domain.TenantType;
import org.opentestsystem.shared.search.domain.AbstractSearchRequest;
import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.index.CompoundIndex;
import org.springframework.data.mongodb.core.index.CompoundIndexes;
import org.springframework.data.mongodb.core.index.Indexed;
import org.springframework.data.mongodb.core.mapping.Document;

import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import com.fasterxml.jackson.annotation.JsonProperty;
import com.thoughtworks.xstream.annotations.XStreamAlias;
import com.thoughtworks.xstream.annotations.XStreamOmitField;

@SuppressWarnings({ "PMD.ShortVariable" })
@Document
@JsonIgnoreProperties(ignoreUnknown = true)
@CompoundIndexes(value = { @CompoundIndex(name = "idAndState", def = "{'entityId':1, 'stateAbbreviation':1}", unique = true) })
@ValidParentExternalId
@XmlNotNull({ "entityId", "entityName" })
@XmlOrderSequence({ "entityId", "entityName" })
public class DistrictEntity implements Sb11Entity {

    private static final long serialVersionUID = -263662900050832330L;
    private static final String GET_RESOURCE_NAME = "/district/";
    public static final FormatType FORMAT_TYPE = FormatType.DISTRICT;
    public static final HierarchyLevel ENTITY_TYPE = HierarchyLevel.DISTRICT;
    public static final TenantType TENANT_TYPE = TenantType.DISTRICT;

    @Id
    @XStreamOmitField
    private String id;

    @Indexed
    @NotBlank(message = "{district.localeducationagencyidentifier.blank}")
    @Alphanumeric(message = "{district.localeducationagencyidentifier.alphanumeric}")
    @Size(max = 40, message = "{district.localeducationagencyidentifier.size.max}")
    @FieldLabel("LocalEducationAgencyIdentifier")
    @XStreamAlias("ResponsibleDistrictIdentifier")
    private String entityId;

    @NotBlank(message = "{district.organizationname.blank}")
    @Ascii(isExtended = true, message = "{district.organizationname.ascii}")
    @Size(max = 60, message = "{district.organizationname.size}")
    @FieldLabel("OrganizationName")
    @XStreamAlias("OrganizationName")
    private String entityName;

    @NotBlank(message = "{parententitytype.blank}")
    @ValidParentEntityType(types = { "STATE", "CLIENT", "GROUPOFSTATES", "GROUPOFDISTRICTS" })
    @FieldLabel("ParentEntityType")
    @XStreamOmitField
    private String parentEntityType;

    @NotBlank(message = "{parententityid.blank}")
    @Size(max = 40, message = "{parententityid.size.max}")
    @FieldLabel("ParentExternalId")
    @XStreamOmitField
    private String parentEntityId; // this is mapped to parent external id in the upload file

    @NotBlank(message = "{stateabbreviation.blank}")
    @ValidStateCode
    @FieldLabel("StateAbbreviation")
    @XStreamOmitField
    private String stateAbbreviation;

    @Numeric(message = "{district.nationwideIdentifier.numeric}")
    @Size(max = 20, message = "{district.nationwideIdentifier.size.max}")
    @FieldLabel("NCESLEAID")
    @XStreamOmitField
    private String nationwideIdentifier;

    @Alpha(message = "{delete.alpha}")
    @Size(max = 6, message = "{delete.size.max}")
    @FieldLabel("Delete")
    @XStreamOmitField
    private String delete;

    @XStreamOmitField
    private String parentId; // this is the mongo id of the parent entity

    public static class Builder implements TestRegistrationBuilder<DistrictEntity> {

        private final Object[] builderVals;

        public Builder(final Object... inVals) {
            this.builderVals = inVals;
        }

        @Override
        public DistrictEntity build() {
            DistrictEntity builtObject = new DistrictEntity();
            builtObject.setEntityId((String) builderVals[0]);
            builtObject.setEntityName((String) builderVals[1]);
            builtObject.setNationwideIdentifier((String) builderVals[2]);
            builtObject.setParentEntityType((String) builderVals[3]);
            builtObject.setParentEntityId((String) builderVals[4]);
            builtObject.setStateAbbreviation(isNotEmpty((String) builderVals[5]) ? ((String) builderVals[5]).toUpperCase() : "");
            builtObject.setDelete((String) builderVals[6]);
            return builtObject;
        }
    }

    @Override
    public String getId() {
        return id;
    }

    @Override
    public void setId(final String inId) {
        this.id = inId;
    }

    @Override
    public Action getAction() {
        return "DELETE".equals(delete) ? Action.DEL : Action.UPD;
    }

    @JsonIgnore
    public void setDelete(final String inAction) {
        this.delete = trim(inAction);
    }

    public String getDelete() {
        return delete;
    }

    @Override
    public HierarchyLevel getParentEntityType() {
        return parentEntityType == null ? null : HierarchyLevel.valueOf(parentEntityType);
    }

    public void setParentEntityType(final String inParentEntityType) {
        this.parentEntityType = trim(inParentEntityType);
    }

    @Override
    @JsonProperty
    public void setParentEntityType(final HierarchyLevel inParentEntityType) {
        if (inParentEntityType != null) {
            this.parentEntityType = inParentEntityType.name();
        }
    }

    @Override
    public String getParentEntityId() {
        return parentEntityId;
    }

    @Override
    public void setParentEntityId(final String inParentEntityId) {
        this.parentEntityId = inParentEntityId;
    }

    @Override
    public String getParentId() {
        return parentId;
    }

    @Override
    public void setParentId(final String inParentId) {
        this.parentId = inParentId;
    }

    @Override
    public String getEntityId() {
        return entityId;
    }

    public void setEntityId(final String inEntityId) {
        this.entityId = inEntityId;
    }

    @Override
    public String getEntityName() {
        return entityName;
    }

    public void setEntityName(final String inEntityName) {
        this.entityName = inEntityName;
    }

    @Override
    public String getStateAbbreviation() {
        return stateAbbreviation;
    }

    public void setStateAbbreviation(final String inStateAbbreviation) {
        this.stateAbbreviation = inStateAbbreviation;
    }

    @JsonProperty
    public String getUrl() {
        return GET_RESOURCE_NAME + this.id;
    }

    public String getNationwideIdentifier() {
        return nationwideIdentifier;
    }

    public void setNationwideIdentifier(final String inNationwideIdentifier) {
        this.nationwideIdentifier = inNationwideIdentifier;
    }

    @Override
    public String[] toStringArray() {
        String[] elements = new String[6];
        elements[0] = this.getEntityId();
        elements[1] = this.getEntityName();
        elements[2] = this.getNationwideIdentifier();
        elements[3] = this.getParentEntityType().toString();
        elements[4] = this.getParentEntityId();
        elements[5] = this.getStateAbbreviation();
        return elements;
    }

    @Override
    public String toString() {
        return ToStringBuilder.reflectionToString(this, ToStringStyle.SHORT_PREFIX_STYLE);
    }

    @Override
    public String getAlternateKey() {
        return new StringBuilder().append("entityId: ").append(entityId).append(", stateAbbreviation: ").append(stateAbbreviation).toString();
    }

    @Override
    public AbstractSearchRequest createAlternateKeySearchRequest() {
        Map<String, String[]> reqMap = new HashMap<String, String[]>();
        reqMap.put(DistrictEntitySearchRequest.SEARCH_KEY_ENTITYID_EXACT, new String[] { entityId });
        reqMap.put(DistrictEntitySearchRequest.SEARCH_KEY_STATE, new String[] { stateAbbreviation });
        DistrictEntitySearchRequest request = new DistrictEntitySearchRequest(reqMap);
        return request;
    }

    @Override
    public FormatType getFormatType() {
        return FORMAT_TYPE;
    }

    @Override
    public HierarchyLevel getEntityType() {
        return ENTITY_TYPE;
    }

    @Override
    public TenantType getTenantType() {
        return TENANT_TYPE;
    }
}
