/*
Educational Online Test Delivery System Copyright (c) 2013 American Institutes for Research

Distributed under the AIR Open Source License, Version 1.0 See accompanying file AIR-License-1_0.txt or at
http://www.smarterapp.org/documents/American_Institutes_for_Research_Open_Source_Software_License.pdf
 */

package org.opentestsystem.delivery.testreg.domain;

import static org.apache.commons.lang.StringUtils.isNotEmpty;
import static org.apache.commons.lang.StringUtils.trim;

import java.util.HashMap;
import java.util.Map;

import javax.validation.constraints.Size;

import org.apache.commons.lang.builder.ToStringBuilder;
import org.apache.commons.lang.builder.ToStringStyle;
import org.hibernate.validator.constraints.NotBlank;
import org.opentestsystem.delivery.testreg.domain.constraints.Alpha;
import org.opentestsystem.delivery.testreg.domain.constraints.Alphanumeric;
import org.opentestsystem.delivery.testreg.domain.constraints.Ascii;
import org.opentestsystem.delivery.testreg.domain.constraints.Numeric;
import org.opentestsystem.delivery.testreg.domain.constraints.ValidParentEntityType;
import org.opentestsystem.delivery.testreg.domain.constraints.ValidParentExternalId;
import org.opentestsystem.delivery.testreg.domain.constraints.ValidStateCode;
import org.opentestsystem.delivery.testreg.domain.search.InstitutionEntitySearchRequest;
import org.opentestsystem.shared.progman.client.domain.TenantType;
import org.opentestsystem.shared.search.domain.AbstractSearchRequest;
import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.index.CompoundIndex;
import org.springframework.data.mongodb.core.index.CompoundIndexes;
import org.springframework.data.mongodb.core.index.Indexed;
import org.springframework.data.mongodb.core.mapping.Document;

import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import com.fasterxml.jackson.annotation.JsonProperty;
import com.thoughtworks.xstream.annotations.XStreamAlias;
import com.thoughtworks.xstream.annotations.XStreamOmitField;

@SuppressWarnings({ "PMD.ShortVariable" })
@Document
@JsonIgnoreProperties(ignoreUnknown = true)
@CompoundIndexes(value = { @CompoundIndex(name = "idAndState", def = "{'entityId':1, 'stateAbbreviation':1}", unique = true) })
@ValidParentExternalId
@XmlNotNull({ "entityId", "entityName" })
@XmlOrderSequence({ "entityId", "entityName" })
public class InstitutionEntity implements Sb11Entity {

    private static final long serialVersionUID = -3855313734975523438L;
    public static final FormatType FORMAT_TYPE = FormatType.INSTITUTION;
    public static final HierarchyLevel ENTITY_TYPE = HierarchyLevel.INSTITUTION;
    public static final TenantType TENANT_TYPE = TenantType.INSTITUTION;

    @Id
    @XStreamOmitField
    private String id;

    @Indexed
    @NotBlank(message = "{institution.entityid.blank}")
    @Alphanumeric(message = "{institution.entityid.alphanumeric}")
    @Size(max = 40, message = "{institution.entityid.size.max}")
    @FieldLabel("InstitutionIdentifier")
    @XStreamAlias("ResponsibleInstitutionIdentifier")
    private String entityId;

    @NotBlank(message = "{institution.entityname.blank}")
    @Ascii(isExtended = true, message = "{institution.entityname.ascii}")
    @Size(max = 60, message = "{institution.entityname.size.max}")
    @FieldLabel("NameOfInstitution")
    @XStreamAlias("NameOfInstitution")
    private String entityName;

    @NotBlank(message = "{parententitytype.blank}")
    @ValidParentEntityType(types = { "STATE", "CLIENT", "GROUPOFSTATES", "DISTRICT", "GROUPOFDISTRICTS", "GROUPOFINSTITUTIONS" })
    @FieldLabel("ParentEntityType")
    @XStreamOmitField
    private String parentEntityType;

    @Size(max = 40, message = "{parententityid.size.max}")
    @NotBlank(message = "{parententityid.blank}")
    @FieldLabel("ParentExternalId")
    @XStreamOmitField
    private String parentEntityId; // this is mapped to parent external id in the upload file

    @NotBlank(message = "{stateabbreviation.blank}")
    @ValidStateCode
    @FieldLabel("StateAbbreviation")
    @XStreamOmitField
    private String stateAbbreviation;

    @NotBlank(message = "{institution.nationwideIdentifier.blank}")
    @Alphanumeric(message = "{institution.nationwideIdentifier.alphanumeric}")
    @Size(max = 40, message = "{institution.nationwideIdentifier.size.max}")
    @FieldLabel("NCESInstitutionId")
    @XStreamOmitField
    private String nationwideIdentifier;

    @Alpha(message = "{delete.alpha}")
    @Size(max = 6, message = "{delete.size.max}")
    @FieldLabel("Delete")
    @XStreamOmitField
    private String delete;

    @XStreamOmitField
    private String parentId; // this is the mongo id of the parent entity

    public static class Builder implements TestRegistrationBuilder<InstitutionEntity> {

        private final Object[] builderVals;

        public Builder(final Object... inVals) {
            this.builderVals = inVals;
        }

        @Override
        public InstitutionEntity build() {
            InstitutionEntity builtObject = new InstitutionEntity();
            builtObject.setEntityId((String) builderVals[DomainIndexConstants.INST_ENTITY_ID_INDEX]);
            builtObject.setEntityName((String) builderVals[DomainIndexConstants.INST_ENTITY_NAME_INDEX]);
            builtObject.setParentEntityType((String) builderVals[DomainIndexConstants.INST_PARENT_ENTITY_TYPE_INDEX]);
            builtObject.setNationwideIdentifier((String) builderVals[DomainIndexConstants.INST_NATIONWIDE_IDENTIFIER_INDEX]);
            builtObject.setParentEntityId((String) builderVals[DomainIndexConstants.INST_PARENT_ENTITY_ID_INDEX]);
            // Adding new column ParentEntityName in import file based on TO-15( SB-1426 ) requirement 3.9.2
            // for Harmonizing Export and Import File Formats new column added to import file and data in corresponding column is not validated or stored 
            builtObject.setStateAbbreviation(isNotEmpty((String) builderVals[DomainIndexConstants.INST_STATE_ABBREVIATION_INDEX]) ? ((String) builderVals[DomainIndexConstants.INST_STATE_ABBREVIATION_INDEX]).toUpperCase() : "");
            builtObject.setDelete((String) builderVals[DomainIndexConstants.INST_DELETE_INDEX]);
            return builtObject;
        }
    }

    @Override
    public String getId() {
        return id;
    }

    @Override
    public void setId(final String inId) {
        this.id = inId;
    }

    @Override
    public Action getAction() {
        return "DELETE".equals(delete) ? Action.DEL : Action.UPD;
    }

    @JsonIgnore
    public void setDelete(final String inAction) {
        this.delete = trim(inAction);
    }

    public String getDelete() {
        return delete;
    }

    @Override
    public HierarchyLevel getParentEntityType() {
        return parentEntityType == null ? null : HierarchyLevel.valueOf(parentEntityType);
    }

    public void setParentEntityType(final String inParentEntityType) {
        this.parentEntityType = trim(inParentEntityType);
    }

    @Override
    @JsonProperty
    public void setParentEntityType(final HierarchyLevel inParentEntityType) {
        if (inParentEntityType != null) {
            this.parentEntityType = inParentEntityType.name();
        }
    }

    @Override
    public String getParentEntityId() {
        return parentEntityId;
    }

    @Override
    public void setParentEntityId(final String inParentEntityId) {
        this.parentEntityId = inParentEntityId;
    }

    @Override
    public String getParentId() {
        return parentId;
    }

    @Override
    public void setParentId(final String inParentId) {
        this.parentId = inParentId;
    }

    @Override
    public String getEntityId() {
        return entityId;
    }

    public void setEntityId(final String inEntityId) {
        this.entityId = inEntityId;
    }

    @Override
    public String getEntityName() {
        return entityName;
    }

    public void setEntityName(final String inEntityName) {
        this.entityName = inEntityName;
    }

    @Override
    public String getStateAbbreviation() {
        return stateAbbreviation;
    }

    public void setStateAbbreviation(final String inStateAbbreviation) {
        this.stateAbbreviation = inStateAbbreviation;
    }

    public String getNationwideIdentifier() {
        return nationwideIdentifier;
    }

    public void setNationwideIdentifier(final String nationwideIdentifier) {
        this.nationwideIdentifier = nationwideIdentifier;
    }

    @Override
    public String[] toStringArray() {
        String[] elements = new String[7];
        elements[DomainIndexConstants.INST_ENTITY_ID_INDEX] = this.getEntityId();
        elements[DomainIndexConstants.INST_ENTITY_NAME_INDEX] = this.getEntityName();
        elements[DomainIndexConstants.INST_PARENT_ENTITY_TYPE_INDEX] = this.getParentEntityType().toString();
        elements[DomainIndexConstants.INST_NATIONWIDE_IDENTIFIER_INDEX] = this.getNationwideIdentifier();
        elements[DomainIndexConstants.INST_PARENT_ENTITY_ID_INDEX] = this.getParentEntityId();
        elements[DomainIndexConstants.INST_STATE_ABBREVIATION_INDEX] = this.getStateAbbreviation();
        return elements;
    }

    @Override
    public String toString() {
        return ToStringBuilder.reflectionToString(this, ToStringStyle.SHORT_PREFIX_STYLE);
    }

    @Override
    public String getAlternateKey() {
        return new StringBuilder().append("entityId: ").append(entityId).append(", stateAbbreviation: ")
                .append(stateAbbreviation).toString();
    }

    @Override
    public AbstractSearchRequest createAlternateKeySearchRequest() {
        Map<String, String[]> reqMap = new HashMap<String, String[]>();
        reqMap.put(InstitutionEntitySearchRequest.SEARCH_KEY_ENTITYID_EXACT, new String[] { entityId });
        reqMap.put(InstitutionEntitySearchRequest.SEARCH_KEY_STATE, new String[] { stateAbbreviation });
        InstitutionEntitySearchRequest request = new InstitutionEntitySearchRequest(reqMap);
        return request;
    }

    @Override
    public FormatType getFormatType() {
        return FORMAT_TYPE;
    }

    @Override
    public HierarchyLevel getEntityType() {
        return ENTITY_TYPE;
    }

    @Override
    public TenantType getTenantType() {
        return TENANT_TYPE;
    }
}
