/*******************************************************************************
 * Educational Online Test Delivery System
 * Copyright (c) 2013 American Institutes for Research
 *
 * Distributed under the AIR Open Source License, Version 1.0
 * See accompanying file AIR-License-1_0.txt or at
 * http://www.smarterapp.org/documents/American_Institutes_for_Research_Open_Source_Software_License.pdf
 ******************************************************************************/

package org.opentestsystem.delivery.testreg.upload.parser;

import static org.opentestsystem.delivery.testreg.upload.ExcelUtils.getRowNum;
import static org.opentestsystem.delivery.testreg.upload.parser.ParserTextUtils.isEmptyRecord;
import static org.opentestsystem.delivery.testreg.upload.parser.ParserTextUtils.padEmptyIfNoColumnAtEnd;
import static org.opentestsystem.delivery.testreg.upload.parser.ParserTextUtils.trimRecords;

import java.io.InputStream;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.poi.ss.usermodel.Row;
import org.apache.poi.ss.usermodel.Sheet;
import org.opentestsystem.delivery.testreg.domain.FormatType;
import org.opentestsystem.delivery.testreg.domain.TestRegistrationBase;
import org.opentestsystem.delivery.testreg.upload.ExcelUtils;
import org.opentestsystem.delivery.testreg.upload.ExcelUtils.ExcelRowMapper;
import org.opentestsystem.delivery.testreg.upload.ExcelUtils.ExcelWorksheetProcessor;
import org.opentestsystem.delivery.testreg.upload.FileUploadUtils;
import org.springframework.beans.factory.annotation.Autowired;

public class TestRegistrationEntityBasedExcelFileParser implements UploadFileParser<Map<FormatType, List<TestRegistrationBase>>> {

    @Autowired
    ExcelUtils excelUtils;

    @Autowired
    private FileUploadUtils fileUploadUtils;

    @Override
    public ParserResult<Map<FormatType, List<TestRegistrationBase>>> parse(final InputStream uploadFile, final String formatType) throws Exception {

        final Map<FormatType, List<TestRegistrationBase>> convertedMap = new HashMap<FormatType, List<TestRegistrationBase>>();
        final List<Integer> ignoredRowNums = new ArrayList<>();

        this.excelUtils.processExcelFile(uploadFile, new ExcelWorksheetProcessor() {
            @Override
            public void process(final Sheet sheet) {
                final List<TestRegistrationBase> excelRows = new ArrayList<TestRegistrationBase>();
                // make formattype an array of size 1 to get around "final" access from the inner class

                final boolean skipHeader = false;
                TestRegistrationEntityBasedExcelFileParser.this.excelUtils.iterateRows(sheet, new ExcelRowMapper() {
                    int totalHeaders;

                    @Override
                    public boolean mapRow(final Row row) {
                        try {
                            final String[] records = TestRegistrationEntityBasedExcelFileParser.this.excelUtils.getRecordsWithNullRowsAsBlank(row);

                            if (getRowNum(row) == HEADER_ROW) {
                                this.totalHeaders = records.length;
                                return true;
                            }
                            if (!isEmptyRecord(records)) {
                                TestRegistrationEntityBasedExcelFileParser.this.fileUploadUtils.entityType(FormatType.valueOf(formatType), excelRows,
                                        padEmptyIfNoColumnAtEnd(this.totalHeaders, trimRecords(records)));
                            } else {
                                ignoredRowNums.add(getRowNum(row));
                            }
                        } catch (final Exception e) {
                            throw new RuntimeException(e);
                        }
                        return true; // Continue mapping the row
                    }
                }, skipHeader, false);

                convertedMap.put(FormatType.valueOf(formatType), excelRows);
            }
        });

        return new ParserResultImpl<Map<FormatType, List<TestRegistrationBase>>>(ignoredRowNums, convertedMap);
    }
}
