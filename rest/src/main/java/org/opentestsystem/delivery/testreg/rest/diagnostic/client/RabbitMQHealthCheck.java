package org.opentestsystem.delivery.testreg.rest.diagnostic.client;

import org.apache.commons.codec.binary.Base64;
import org.opentestsystem.delivery.testreg.rest.diagnostic.model.RabbitMQStatus;
import org.springframework.http.*;
import org.springframework.web.client.RestClientException;
import org.springframework.web.client.RestTemplate;

import static java.lang.String.format;

import java.net.URI;

public class RabbitMQHealthCheck {
    final private String host;
    final private RestTemplate restTemplate;
    final private HttpEntity<String> request;
    final private URI alivenessUri;
    final static private String healthCheckUrl = "http://{host}:15672/api/healthchecks/node";

    public RabbitMQHealthCheck(final RestTemplate restTemplate, String host, final String username, final String password) {
        this.host = host;

        String credentials = String.format("%s:%s", username, password);
        byte[] credentialsBytes = credentials.getBytes();
        byte[] base64Bytes = Base64.encodeBase64(credentialsBytes);
        String base64 = new String(base64Bytes);

        HttpHeaders headers = new HttpHeaders();
        headers.add("Authorization", "Basic " + base64);
        request = new HttpEntity<>(headers);

        // aliveness test for the rabbitmq virtual host "/", url encoded as %2F
        alivenessUri = URI.create(format("http://%s:15672/api/aliveness-test/%%2F", host));
        this.restTemplate = restTemplate;
    }

    public String getHost() {
        return host;
    }

    private ResponseEntity<RabbitMQStatus> getAlivenessTest() throws RestClientException {
        return restTemplate.exchange(alivenessUri, HttpMethod.GET, request, RabbitMQStatus.class);
    }

    private ResponseEntity<RabbitMQStatus> getHealthCheck() throws RestClientException {
        return restTemplate.exchange(healthCheckUrl, HttpMethod.GET, request, RabbitMQStatus.class, host);
    }

    public RabbitMQStatus getStatus() throws RestClientException {
        try {
            return getHealthCheck().getBody();
        } catch (RestClientException restEx) {
            // fallback to aliveness test for older rabbitmq versions
            return getAlivenessTest().getBody();
        }
    }
}
