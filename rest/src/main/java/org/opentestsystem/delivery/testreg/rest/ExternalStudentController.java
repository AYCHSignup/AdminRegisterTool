/*******************************************************************************
 * Educational Online Test Delivery System
 * Copyright (c) 2016 Regents of the University of California
 *
 * Distributed under the AIR Open Source License, Version 1.0
 * See accompanying file AIR-License-1_0.txt or at
 * http://www.smarterapp.org/documents/American_Institutes_for_Research_Open_Source_Software_License.pdf
 *
 * SmarterApp Open Source Assessment Software Project: http://smarterapp.org
 * Developed by Fairway Technologies, Inc. (http://fairwaytech.com)
 * for the Smarter Balanced Assessment Consortium (http://smarterbalanced.org)
 ******************************************************************************/

package org.opentestsystem.delivery.testreg.rest;

import io.swagger.annotations.ApiOperation;
import org.opentestsystem.delivery.testreg.domain.Student;
import org.opentestsystem.delivery.testreg.domain.StudentBatchStatus;
import org.opentestsystem.delivery.testreg.domain.StudentUpsert;
import org.opentestsystem.delivery.testreg.rest.external.mappers.StudentMapper;
import org.opentestsystem.delivery.testreg.rest.external.models.StudentDeleteDto;
import org.opentestsystem.delivery.testreg.rest.external.models.StudentDto;
import org.opentestsystem.delivery.testreg.rest.external.services.AmqpRabbitService;
import org.opentestsystem.delivery.testreg.service.ExternalStudentService;
import org.opentestsystem.delivery.testreg.service.StudentBatchStatusService;
import org.opentestsystem.delivery.testreg.service.StudentService;
import org.opentestsystem.shared.web.AbstractRestController;
import org.owasp.esapi.waf.internal.InterceptingHTTPServletRequest;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.security.access.annotation.Secured;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContext;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.oauth2.common.exceptions.UnauthorizedUserException;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.List;

@Controller
public class ExternalStudentController extends AbstractRestController {

    @Autowired
    private StudentService studentService;

    @Autowired
    private AmqpRabbitService amqpService;

    @Autowired
    private StudentBatchStatusService studentBatchStatusService;

    @Autowired
    private ExternalStudentService externalStudentService;

    @RequestMapping(value = "/external/student/{stateCode}/{id}", method = RequestMethod.GET, produces = { MediaType.APPLICATION_JSON_VALUE })
    @Secured({ "ROLE_Student Read" })
    @ResponseBody
    @ApiOperation(value="", nickname = "Find student by SSID")
    public StudentDto findStudentById(@PathVariable final String stateCode, @PathVariable final String id, final HttpServletResponse response) {
        Student student =  studentService.findByStudentIdAndStateAbbreviation(id, stateCode);
        if(student == null) {
            response.setStatus(HttpServletResponse.SC_NOT_FOUND);
            return null;
        }
        return StudentMapper.mapFrom(student);
    }

    @RequestMapping(value = "/external/student/{stateCode}", method = RequestMethod.POST, consumes = MediaType.APPLICATION_JSON_VALUE, produces = { MediaType.APPLICATION_JSON_VALUE })
    @Secured({ "ROLE_Student Modify" })
    @ResponseBody
    @ApiOperation(value="", nickname = "Insert or update student")
    public StudentDto saveStudent(@PathVariable final String stateCode, @RequestBody final StudentDto studentDto, final HttpServletRequest request, final HttpServletResponse response) throws IOException {
        StudentUpsert studentUpsert = externalStudentService.upsertStudent(StudentMapper.mapTo(studentDto), amqpService.getSecurity(), stateCode);
        response.setStatus(studentUpsert.isInsert() ? HttpServletResponse.SC_CREATED : HttpServletResponse.SC_NO_CONTENT);
        response.setHeader("Location", request.getRequestURL().toString() + "/" + studentUpsert.getStudent().getEntityId());
        return StudentMapper.mapFrom(studentUpsert.getStudent());
    }

    @RequestMapping(value = "external/student/{stateCode}/{id}", method = RequestMethod.DELETE)
    @Secured({ "ROLE_Student Modify" })
    @ApiOperation(value="", nickname = "Delete a student")
    public void deleteStudent(@PathVariable final String stateCode, @PathVariable final String id, final HttpServletResponse response) {
        response.setStatus(externalStudentService.deleteStudent(id, amqpService.getSecurity(), stateCode) ? HttpServletResponse.SC_NO_CONTENT : HttpServletResponse.SC_NOT_FOUND);
    }

    @RequestMapping(value = "external/student/{stateCode}/batch", method = RequestMethod.DELETE)
    @Secured({ "ROLE_Student Modify" })
    @ApiOperation(value="", nickname = "Delete multiple students")
    public void deleteStudents(@PathVariable final String stateCode, @RequestBody final List<StudentDeleteDto> studentsToDelete, final HttpServletRequest request, final HttpServletResponse response) throws Exception {
        response.setStatus(HttpServletResponse.SC_ACCEPTED);
        String batchId =  studentBatchStatusService.createStudentBatchStatus(studentsToDelete.size(), false, request.getUserPrincipal().getName(), stateCode);
        amqpService.sendDelete(studentsToDelete, batchId);
        response.setHeader("Location", request.getRequestURL().toString().replace("/"+stateCode + "", "") + "/" + batchId);
    }

    @RequestMapping(value = "/external/student/batch/{batchId}", method = RequestMethod.GET, produces = { MediaType.APPLICATION_JSON_VALUE })
    @Secured({ "ROLE_Student Read" })
    @ResponseBody
    @ApiOperation(value="", nickname = "Get batch information")
    public StudentBatchStatus findBatchById(@PathVariable final String batchId, final HttpServletRequest request)  {
        StudentBatchStatus status =  studentBatchStatusService.getStudentBatchStatus(batchId);
        if(request.getUserPrincipal().getName().compareTo(status.getSubmittedBy()) == 0) return status;
        throw new UnauthorizedUserException("Only the user that submitted a batch may view the status of that batch.");
    }

    @RequestMapping(value = "/external/student/{stateCode}/batch", method = RequestMethod.POST, consumes = MediaType.APPLICATION_JSON_VALUE, produces = { MediaType.APPLICATION_JSON_VALUE })
    @Secured({ "ROLE_Student Modify" })
    @ApiOperation(value="", nickname = "Insert or update multiple students")
    public void saveStudents(@PathVariable final String stateCode, @RequestBody final List<StudentDto> studentDtos, final HttpServletRequest request, final HttpServletResponse response) throws Exception {
        response.setStatus(HttpServletResponse.SC_ACCEPTED);
        String batchId = studentBatchStatusService.createStudentBatchStatus(studentDtos.size(), true, request.getUserPrincipal().getName(), stateCode);
        amqpService.sendUpsert(studentDtos, batchId, stateCode);
        response.setHeader("Location", request.getRequestURL().toString().replace("/"+stateCode + "", "") + "/" + batchId);
    }
}
