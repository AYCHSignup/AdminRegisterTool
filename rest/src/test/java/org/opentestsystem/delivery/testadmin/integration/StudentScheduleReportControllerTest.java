/*******************************************************************************
 * Educational Online Test Delivery System
 * Copyright (c) 2013 American Institutes for Research
 * 
 * Distributed under the AIR Open Source License, Version 1.0
 * See accompanying file AIR-License-1_0.txt or at
 * http://www.smarterapp.org/documents/American_Institutes_for_Research_Open_Source_Software_License.pdf
 ******************************************************************************/
package org.opentestsystem.delivery.testadmin.integration;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertNotNull;
import static org.springframework.test.util.ReflectionTestUtils.setField;

import java.io.ByteArrayInputStream;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TreeSet;

import javax.annotation.Resource;

import org.joda.time.DateTime;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.delivery.testadmin.domain.Status;
import org.opentestsystem.delivery.testadmin.domain.TestStatus;
import org.opentestsystem.delivery.testadmin.domain.schedule.Schedule;
import org.opentestsystem.delivery.testadmin.domain.schedule.ScheduledDay;
import org.opentestsystem.delivery.testadmin.domain.schedule.ScheduledFacility;
import org.opentestsystem.delivery.testadmin.domain.schedule.ScheduledSeat;
import org.opentestsystem.delivery.testadmin.domain.schedule.ScheduledTimeSlot;
import org.opentestsystem.delivery.testadmin.persistence.TestStatusRepository;
import org.opentestsystem.delivery.testadmin.service.ScheduleReportService;
import org.opentestsystem.delivery.testreg.domain.Assessment;
import org.opentestsystem.delivery.testreg.domain.FormatType;
import org.opentestsystem.delivery.testreg.domain.InstitutionEntity;
import org.opentestsystem.delivery.testreg.domain.Sb11NonEntity;
import org.opentestsystem.delivery.testreg.domain.Student;
import org.opentestsystem.delivery.testreg.domain.TestRegistrationBase;
import org.opentestsystem.delivery.testreg.integration.AbstractSecuredRestEmbeddedMongoTest;
import org.opentestsystem.delivery.testreg.persistence.StudentRepository;
import org.opentestsystem.delivery.testreg.service.TestRegPersister;
import org.opentestsystem.shared.search.domain.AbstractSearchRequest;
import org.opentestsystem.shared.search.domain.SearchResponse;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.mock.web.MockHttpServletResponse;

import com.google.common.collect.Maps;
import com.lowagie.text.pdf.PdfReader;

public class StudentScheduleReportControllerTest extends AbstractSecuredRestEmbeddedMongoTest {

    private Map<String, String> uploadParams;
    @Resource(name = "studentScheduleReportService")
    private ScheduleReportService scheduleReportService;

    InstitutionEntity institutionEntity;

    @Before
    public void buildUploadParams() {

        uploadParams = Maps.newHashMap();
        uploadParams.put("scheduleName", "scheduleDemo");
        uploadParams.put("tenantId", "524af61ae4b0b02763aa0fe0");
        uploadParams.put("startDate", "2016-06-01");
        uploadParams.put("endDate", "2016-06-02");

    }

    @Before
    public void setup() {
        institutionEntity = (new InstitutionEntity.Builder("10001", "MiddletonSchool", "CLIENT", "234", "000000", "CA",
                "ADD").build());
        mongoTemplate.save(institutionEntity);
        Schedule schedule = createShedule();
        mongoTemplate.save(schedule);
    }

    @After
    public void teardown() {
        mongoTemplate.dropCollection(Schedule.class);
    }

    @Test
    public void createStudentScheduledReport() throws Exception {
        setField(scheduleReportService, "entityService", new MockEntityService());
        setField(scheduleReportService, "studentRepos", new MockStudentService());
        setField(scheduleReportService, "studentTestRepository", new MockTestStatusRepository());
        uploadParams.put("institutionId", institutionEntity.getId());
        MockHttpServletResponse response = callGETRestService1("/studentScheduleReport.pdf"
                + buildQueryString(uploadParams));
        assertNotNull(response);
        assertEquals("Content-Type is not equal application/pdf", "application/pdf", response.getContentType());
        assertNotNull("Student Scheduled Report Data is null", response.getContentAsByteArray());
        byte[] resData = response.getContentAsByteArray();
        ByteArrayInputStream st = new ByteArrayInputStream(resData);
        PdfReader reader = new PdfReader(st);
        byte[] streamBytes = reader.getPageContent(1);
        assertNotNull("Student Scheduled Report Data is null", streamBytes);
    }

    private Schedule createShedule() {
        Schedule schedule = new Schedule();
        ScheduledSeat seat1 = new ScheduledSeat();
        ScheduledSeat seat2 = new ScheduledSeat();
        ScheduledSeat seat3 = new ScheduledSeat();

        Student student1 = new Student();
        student1.setEntityId("0001");
        student1.setFirstName("1FName");
        student1.setFirstName("1LName");
        student1.setMiddleName("A");
        student1.setStateAbbreviation("WI");
        student1.setExternalSsid("1FNameLName@edu.org");

        Student student2 = new Student();
        student1.setEntityId("0002");
        student2.setFirstName("2FName");
        student2.setFirstName("2LName");
        student2.setMiddleName("A");
        student2.setStateAbbreviation("WI");
        student2.setExternalSsid("2FNameLName@edu.org");
        Student student3 = new Student();
        student1.setEntityId("0003");
        student3.setFirstName("3FName");
        student3.setFirstName("3LName");
        student3.setMiddleName("A");
        student3.setExternalSsid("3FNameLName@edu.org");
        student3.setStateAbbreviation("WI");

        Assessment assessment1 = new Assessment();
        assessment1.setTestName("TEST1");
        assessment1.setTestLabel("TEST1-WI");

        Assessment assessment2 = new Assessment();
        assessment2.setTestName("TEST2");
        assessment2.setTestLabel("TEST2-WI");

        Assessment assessment3 = new Assessment();
        assessment3.setTestName("TEST3");
        assessment3.setTestLabel("TEST3-WI");

        Set<ScheduledSeat> sets = new HashSet<ScheduledSeat>();
        seat1.setStudent(student1);
        seat1.setAssessment(assessment1);

        seat2.setStudent(student2);
        seat2.setAssessment(assessment2);

        seat3.setStudent(student3);
        seat3.setAssessment(assessment3);
        sets.add(seat1);
        sets.add(seat2);
        sets.add(seat3);

        ScheduledTimeSlot sts1 = new ScheduledTimeSlot();
        sts1.setStartTime(new DateTime(2024, 06, 01, 17, 0));
        sts1.setEndTime(new DateTime(2024, 06, 01, 18, 0));
        sts1.setSeats(sets);

        TreeSet<ScheduledTimeSlot> sts = new TreeSet<ScheduledTimeSlot>();
        sts.add(sts1);

        List<ScheduledDay> days = new ArrayList<ScheduledDay>();
        ScheduledDay scheduledDay = new ScheduledDay();
        scheduledDay.setDay(new DateTime(2024, 6, 1, 0, 0));

        ScheduledFacility scheduledFacility = new ScheduledFacility();
        scheduledFacility.setLocation("Madison West");
        scheduledFacility.setTimeSlots(sts);
        scheduledDay.setFacilities(Arrays.asList(new ScheduledFacility[] { scheduledFacility }));
        days.add(scheduledDay);

        // create schedule
        schedule = new Schedule();
        schedule.setScheduleName("scheduleDemo");
        schedule.setInstitutionId("53d667dded99f8b7b41e15fa");
        schedule.setStartDate(new DateTime(2024, 6, 1, 0, 0));
        schedule.setEndDate(new DateTime(2024, 6, 2, 0, 0));
        schedule.setInstitutionIdentifier("INS1");
        schedule.setScheduledDays(days);
        return schedule;
    }
}

class MockEntityService implements TestRegPersister {

    private int saveCount = 0;
    private int updateCount = 0;
    private int deleteCount = 0;

    @SuppressWarnings("unused")
    public void resetCounts() {
        saveCount = 0;
        updateCount = 0;
        deleteCount = 0;
    }

    @Override
    public <T extends TestRegistrationBase> T findById(String pkId, FormatType formatType) {
        InstitutionEntity entity = new InstitutionEntity();
        entity.setId("53ff860fde0d39090ad54dc7");
        return (T) entity;
    }

    @Override
    public <T extends TestRegistrationBase> List<T> findAll(FormatType formatType) {
        return null;
    }

    @Override
    public <T extends TestRegistrationBase> T saveDomainObject(T domainObj) {
        return null;
    }

    public <T extends TestRegistrationBase> T updateDomainObject(T domainObj) {
        return null;
    }

    @Override
    public <T extends TestRegistrationBase> void deleteDomainObject(T domainObj) {

    }

    @Override
    public <T extends TestRegistrationBase> void deleteDomainObject(String pkId, FormatType formatType) {

    }

    @Override
    public <T extends TestRegistrationBase> List<T> saveDomainObjects(List<T> domainObjList) {
        saveCount += domainObjList.size();

        return domainObjList;
    }

    @Override
    public <T extends TestRegistrationBase> List<T> updateDomainObjects(List<T> domainObjList) {
        updateCount += domainObjList.size();

        return domainObjList;
    }

    @Override
    public <T extends TestRegistrationBase> void deleteDomainObjects(List<T> domainObjList) {
        deleteCount += domainObjList.size();

    }

    @Override
    public <T extends TestRegistrationBase> SearchResponse<T> searchDomainObjects(AbstractSearchRequest searchRequest,
            FormatType formatType) {
        return null;
    }

    @Override
    public <T extends TestRegistrationBase> boolean hasAssociatedEntity(T domainObj) {
        return false;
    }

}

class MockStudentService implements StudentRepository {

    public List<Student> findStudentsByInstitution(String institutionId) {
        List<Student> studentList = new ArrayList<Student>();
        Student student1 = new Student();
        student1.setEntityId("0001");
        student1.setFirstName("1FName");
        student1.setFirstName("1LName");
        student1.setMiddleName("A");
        student1.setStateAbbreviation("WI");
        student1.setExternalSsid("1FNameLName@edu.org");

        Student student2 = new Student();
        student2.setEntityId("0002");
        student2.setFirstName("2FName");
        student2.setFirstName("2LName");
        student2.setMiddleName("A");
        student2.setStateAbbreviation("WI");
        student2.setExternalSsid("2FNameLName@edu.org");
        Student student3 = new Student();
        student3.setEntityId("0003");
        student3.setFirstName("3FName");
        student3.setFirstName("3LName");
        student3.setMiddleName("A");
        student3.setExternalSsid("3FNameLName@edu.org");
        student3.setStateAbbreviation("WI");
        studentList.add(student1);
        studentList.add(student2);
        studentList.add(student3);
        return studentList;
    }

    @Override
    public SearchResponse<Student> search(AbstractSearchRequest arg0) {
        // TODO Auto-generated method stub
        return null;
    }

    @Override
    public <S extends Student> List<S> save(Iterable<S> entites) {
        // TODO Auto-generated method stub
        return null;
    }

    @Override
    public List<Student> findAll() {
        // TODO Auto-generated method stub
        return null;
    }

    @Override
    public List<Student> findAll(Sort sort) {
        // TODO Auto-generated method stub
        return null;
    }

    @Override
    public Page<Student> findAll(Pageable pageable) {
        // TODO Auto-generated method stub
        return null;
    }

    @Override
    public <S extends Student> S save(S entity) {
        // TODO Auto-generated method stub
        return null;
    }

    @Override
    public Student findOne(String id) {
        // TODO Auto-generated method stub
        return null;
    }

    @Override
    public boolean exists(String id) {
        // TODO Auto-generated method stub
        return false;
    }

    @Override
    public Iterable<Student> findAll(Iterable<String> ids) {
        // TODO Auto-generated method stub
        return null;
    }

    @Override
    public long count() {
        // TODO Auto-generated method stub
        return 0;
    }

    @Override
    public void delete(String id) {
        // TODO Auto-generated method stub

    }

    @Override
    public void delete(Student entity) {
        // TODO Auto-generated method stub

    }

    @Override
    public void delete(Iterable<? extends Student> entities) {
        // TODO Auto-generated method stub

    }

    @Override
    public void deleteAll() {
        // TODO Auto-generated method stub

    }

    @Override
    public <T extends Sb11NonEntity> T findByAlternateKey(AbstractSearchRequest searchRequest, Class<T> clazz) {
        // TODO Auto-generated method stub
        return null;
    }

    @Override
    public long getStudentCount(String institutionId) {
        // TODO Auto-generated method stub
        return 0;
    }

    @Override
    public List<Student> findStudentsByInstitutions(List<String> institutionMongoIdList) {
        // TODO Auto-generated method stub
        return null;
    }

    @Override
    public List<Student> findStudentsByDistrict(String districtMongoId) {
        // TODO Auto-generated method stub
        return null;
    }

    @Override
    public List<Student> findStudentsByState(String stateAbbreviation) {
        // TODO Auto-generated method stub
        return null;
    }

    @Override
    public Student findByEntityIdAndStateAbbreviation(String entityId, String stateAbbreviation) {
        // TODO Auto-generated method stub
        return null;
    }

    @Override
    public Student findByExternalSsidAndStateAbbreviation(String externalSsid, String stateAbbreviation) {
        // TODO Auto-generated method stub
        return null;
    }

    @Override
    public List<Student> findByInstitutionIdentifierAndStateAbbreviation(String institutionIdentifier,
            String stateAbbreviation) {
        // TODO Auto-generated method stub
        return null;
    }

    @Override
    public List<Student> findAllByRangeAndLimitWithInstitutionFilter(String mongoId, int pageSize,
            List<String> institutionMongoIdList) {
        // TODO Auto-generated method stub
        return null;
    }

    @Override
    public long countByInstitutionFilter(List<String> institutionMongoIds) {
        // TODO Auto-generated method stub
        return 0;
    }

}

class MockTestStatusRepository implements TestStatusRepository {

    @Override
    public SearchResponse<TestStatus> search(AbstractSearchRequest arg0) {
        // TODO Auto-generated method stub
        return null;
    }

    @Override
    public <S extends TestStatus> List<S> save(Iterable<S> entites) {
        // TODO Auto-generated method stub
        return null;
    }

    @Override
    public List<TestStatus> findAll() {
        // TODO Auto-generated method stub
        return null;
    }

    @Override
    public List<TestStatus> findAll(Sort sort) {
        // TODO Auto-generated method stub
        return null;
    }

    @Override
    public Page<TestStatus> findAll(Pageable pageable) {
        // TODO Auto-generated method stub
        return null;
    }

    @Override
    public <S extends TestStatus> S save(S entity) {
        // TODO Auto-generated method stub
        return null;
    }

    @Override
    public TestStatus findOne(String id) {
        // TODO Auto-generated method stub
        return null;
    }

    @Override
    public boolean exists(String id) {
        // TODO Auto-generated method stub
        return false;
    }

    @Override
    public Iterable<TestStatus> findAll(Iterable<String> ids) {
        // TODO Auto-generated method stub
        return null;
    }

    @Override
    public long count() {
        // TODO Auto-generated method stub
        return 0;
    }

    @Override
    public void delete(String id) {
        // TODO Auto-generated method stub

    }

    @Override
    public void delete(TestStatus entity) {
        // TODO Auto-generated method stub

    }

    @Override
    public void delete(Iterable<? extends TestStatus> entities) {
        // TODO Auto-generated method stub

    }

    @Override
    public void deleteAll() {
        // TODO Auto-generated method stub

    }

    @Override
    public List<TestStatus> findStudentReport(Collection<String> studentIdList, String stateAbbreviation,
            String assessmentId, int opportunity, String testStatus) {
        TestStatus status = new TestStatus();
        status.setStudentId("0001");
        status.setAssessmentId("53ff860fde0d39090ad54dc8");
        status.setStatus(Status.COMPLETED);
        status.setActualComplete(DateTime.now());
        return Arrays.asList(status);

    }

    @Override
    public TestStatus findByReportAlternateId(String studentId, String stateAbbreviation, String assessmentId,
            int opportunity) {
        // TODO Auto-generated method stub
        return null;
    }

    @Override
    public List<TestStatus> findByStudentIds(Collection<String> studentIds) {
        // TODO Auto-generated method stub
        return null;
    }

}
