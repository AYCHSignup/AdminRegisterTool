/*******************************************************************************
 * Educational Online Test Delivery System
 * Copyright (c) 2013 American Institutes for Research
 *
 * Distributed under the AIR Open Source License, Version 1.0
 * See accompanying file AIR-License-1_0.txt or at
 * http://www.smarterapp.org/documents/American_Institutes_for_Research_Open_Source_Software_License.pdf
 ******************************************************************************/
package org.opentestsystem.delivery.testreg.integration;

import static org.hamcrest.core.Is.is;
import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertNotNull;
import static org.junit.Assert.assertNull;
import static org.junit.Assert.assertThat;
import static org.junit.Assert.fail;
import static org.opentestsystem.delivery.testreg.domain.TestRegPermission.ENTITY_MODIFY;
import static org.opentestsystem.delivery.testreg.domain.TestRegPermission.ENTITY_READ;

import java.io.BufferedReader;
import java.io.ByteArrayInputStream;
import java.io.InputStreamReader;
import java.util.Map;

import org.apache.poi.hssf.usermodel.HSSFWorkbook;
import org.apache.poi.ss.usermodel.Row;
import org.apache.poi.ss.usermodel.Sheet;
import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.delivery.testreg.domain.ClientEntity;
import org.opentestsystem.delivery.testreg.domain.GroupOfInstitutionsEntity;
import org.opentestsystem.delivery.testreg.domain.HierarchyLevel;
import org.opentestsystem.delivery.testreg.domain.Sb11Entity;
import org.opentestsystem.shared.docs.annotation.ApiDocExample;
import org.opentestsystem.shared.search.domain.SearchResponse;
import org.springframework.mock.web.MockHttpServletResponse;

import au.com.bytecode.opencsv.CSVReader;

import com.google.common.collect.Maps;

@SuppressWarnings("unchecked")
public class GroupOfInstitutionsControllerTest extends AbstractSecuredRestEmbeddedMongoTest {

    private Map<String, Object> params;
    private Map<String, String> uploadParams;

    @Before
    public void buildParams() {
        // Insert parent entity
        mongoTemplate.insert(new ClientEntity.Builder("testclient", "test client", "asdfas-asdfasdf-asdfasd", "true").build());

        params = Maps.newHashMap();
        params.put("entityId", "1234");
        params.put("entityName", "MIDWEST GROUP");
        params.put("parentEntityType", HierarchyLevel.CLIENT);
        params.put("parentEntityId", "testclient");
        params.put("stateAbbreviation", "WI");

        uploadParams = Maps.newHashMap();
        uploadParams.put("entityId", "1234");
        uploadParams.put("entityName", "MIDWEST GROUP");
        uploadParams.put("parentEntityType", HierarchyLevel.CLIENT.toString());
        uploadParams.put("parentEntityId", "testclient");
        uploadParams.put("stateAbbreviation", "WI");
        uploadParams.put("currentPage", "0");
    }

    @Test
    public void saveGroupOfInstitutionsEntity() throws InterruptedException {
        GroupOfInstitutionsEntity savedGroupOfInstitutionsEntity = callPOSTRestService("/groupofinstitutions", params,
                GroupOfInstitutionsEntity.class, ENTITY_MODIFY);
        assertEquals("GroupOfInstitutionsEntity should be created", 1,
                mongoTemplate.findAll(GroupOfInstitutionsEntity.class).size());
        assertNotNull(savedGroupOfInstitutionsEntity);
    }

    @Test
    public void updateGroupOfInstitutionsEntity() throws InterruptedException {
        GroupOfInstitutionsEntity savedGroupOfInstitutionsEntity = callPOSTRestService("/groupofinstitutions", params,
                GroupOfInstitutionsEntity.class, ENTITY_MODIFY);
        assertNotNull(savedGroupOfInstitutionsEntity);
        params.put("id", savedGroupOfInstitutionsEntity.getId());
        params.put("entityId", "890");
        GroupOfInstitutionsEntity updatedGroupOfInstitutionsEntity = callPUTRestService("/groupofinstitutions/"
                + savedGroupOfInstitutionsEntity.getId(), params, GroupOfInstitutionsEntity.class, ENTITY_MODIFY);
        assertNotNull(updatedGroupOfInstitutionsEntity);
        assertEquals("GroupOfInstitutionsEntity should be updated", updatedGroupOfInstitutionsEntity.getEntityId(),
                "890");
    }

    @Test
    public void findGroupOfInstitutionsEntity() throws InterruptedException {
        GroupOfInstitutionsEntity savedGroupOfInstitutionsEntity = callPOSTRestService("/groupofinstitutions", params,
                GroupOfInstitutionsEntity.class, ENTITY_MODIFY);
        assertEquals("GroupOfInstitutionsEntity should be created", 1,
                mongoTemplate.findAll(GroupOfInstitutionsEntity.class).size());
        assertNotNull(savedGroupOfInstitutionsEntity);
        GroupOfInstitutionsEntity fetchedGroupOfInstitutionsEntity = callGETRestService("/groupofinstitutions/"
                + savedGroupOfInstitutionsEntity.getId(), GroupOfInstitutionsEntity.class, ENTITY_READ);
        assertNotNull("GroupOfInstitutionsEntity was null!", fetchedGroupOfInstitutionsEntity);
    }

    @Test
    public void deleteGroupOfInstitutionsEntity() throws InterruptedException {
        GroupOfInstitutionsEntity savedGroupOfInstitutionsEntity = callPOSTRestService("/groupofinstitutions", params,
                GroupOfInstitutionsEntity.class, ENTITY_MODIFY);
        assertEquals("GroupOfInstitutionsEntity should be created", 1,
                mongoTemplate.findAll(GroupOfInstitutionsEntity.class).size());
        assertNotNull(savedGroupOfInstitutionsEntity);
        try {
            callDeleteRestService("/groupofinstitutions/" + savedGroupOfInstitutionsEntity.getId(), ENTITY_MODIFY);
        } catch (Exception e) {
            fail("Cannot delete configuration");
        }
        GroupOfInstitutionsEntity fetchedGroupOfInstitutionsEntity = callGETRestService("/groupofinstitutions/"
                + savedGroupOfInstitutionsEntity.getId(), GroupOfInstitutionsEntity.class, ENTITY_READ);
        assertNull("GroupOfInstitutionsEntity was null!", fetchedGroupOfInstitutionsEntity);
    }

    @Test
    public void searchGroupOfInstitutionsEntity() throws InterruptedException {
        GroupOfInstitutionsEntity savedGroupOfInstitutionsEntity = callPOSTRestService("/groupofinstitutions", params,
                GroupOfInstitutionsEntity.class, ENTITY_MODIFY);
        assertEquals("GroupOfInstitutionsEntity should be created", 1,
                mongoTemplate.findAll(GroupOfInstitutionsEntity.class).size());
        assertNotNull(savedGroupOfInstitutionsEntity);

        Map<String, String> params = Maps.newHashMap();
        params.put("entityId", savedGroupOfInstitutionsEntity.getEntityId());
        SearchResponse<Sb11Entity> resp = callGETRestService("/groupofinstitution" + buildQueryString(params),
                SearchResponse.class, ENTITY_READ);
        assertNotNull(resp);
        assertEquals("only one should be found", 1, resp.getReturnCount());
    }

    @Test
    @ApiDocExample(rank = -1)
    public void exportToExcelWithPageParams() throws Exception {
        GroupOfInstitutionsEntity entity = callPOSTRestService("/groupofinstitutions", params,
                GroupOfInstitutionsEntity.class, ENTITY_MODIFY);
        assertEquals("GroupOfInstitutionEntity should be created", 1,
                mongoTemplate.findAll(GroupOfInstitutionsEntity.class).size());
        assertNotNull(entity);

        MockHttpServletResponse response = callGETRestService1("/groupofinstitutions.xls"
                + buildQueryString(uploadParams), ENTITY_READ);
        assertNotNull(response);
        assertEquals("Content-Type is not equal application/vnd.ms-excel", "application/vnd.ms-excel",
                response.getContentType());
        assertNotNull("GroupOfInstitutions ExportExcel Data is null", response.getContentAsByteArray());
        byte[] resData = response.getContentAsByteArray();
        ByteArrayInputStream st = new ByteArrayInputStream(resData);
        HSSFWorkbook workbook = new HSSFWorkbook(st);
        Sheet sheet = workbook.getSheetAt(0);

        Row dataRow = sheet.getRow(1);
        assertThat(dataRow.getCell(0).getStringCellValue(), is(entity.getEntityId()));
        assertThat(dataRow.getCell(1).getStringCellValue(), is(entity.getEntityName()));
        assertThat(dataRow.getCell(2).getStringCellValue(), is(entity.getParentEntityType().toString()));
        assertThat(dataRow.getCell(3).getStringCellValue(), is("test client"));// Parent Entity Name

    }

    @Test
    @ApiDocExample(rank = -1)
    public void exportToExcelWithExtension() throws Exception {
        GroupOfInstitutionsEntity entity = callPOSTRestService("/groupofinstitutions", params,
                GroupOfInstitutionsEntity.class, ENTITY_MODIFY);
        assertEquals("GroupOfInstitutionEntity should be created", 1,
                mongoTemplate.findAll(GroupOfInstitutionsEntity.class).size());
        assertNotNull(entity);

        MockHttpServletResponse response = callGETRestService1("/groupofinstitutions.xls", ENTITY_READ);
        assertNotNull(response);
        assertEquals("Content-Type is not equal application/vnd.ms-excel", "application/vnd.ms-excel",
                response.getContentType());
        assertNotNull("GroupOfInstitutions ExportExcel Data is null", response.getContentAsByteArray());
        byte[] resData = response.getContentAsByteArray();
        ByteArrayInputStream st = new ByteArrayInputStream(resData);
        HSSFWorkbook workbook = new HSSFWorkbook(st);
        Sheet sheet = workbook.getSheetAt(0);

        Row dataRow = sheet.getRow(1);
        assertThat(dataRow.getCell(0).getStringCellValue(), is(entity.getEntityId()));
        assertThat(dataRow.getCell(1).getStringCellValue(), is(entity.getEntityName()));
        assertThat(dataRow.getCell(2).getStringCellValue(), is(entity.getParentEntityType().toString()));
        assertThat(dataRow.getCell(3).getStringCellValue(), is("test client"));// Parent Entity Name
    }

    @Test
    @ApiDocExample(rank = -1)
    public void exportToCsvWithExtension() throws Exception {
        GroupOfInstitutionsEntity entity = callPOSTRestService("/groupofinstitutions", params,
                GroupOfInstitutionsEntity.class, ENTITY_MODIFY);
        assertEquals("GroupOfInstitutionEntity should be created", 1,
                mongoTemplate.findAll(GroupOfInstitutionsEntity.class).size());
        assertNotNull(entity);

        MockHttpServletResponse response = callGETRestService1("/groupofinstitutions.csv", ENTITY_READ);
        assertNotNull(response);
        assertEquals("Content-Type is not equal application/csv", com.google.common.net.MediaType.CSV_UTF_8.toString(),
                response.getContentType());
        assertNotNull("GroupOfInstitutions Export CSV Data is null", response.getContentAsByteArray());
        byte[] resData = response.getContentAsByteArray();

        ByteArrayInputStream st = new ByteArrayInputStream(resData);
        BufferedReader reader = new BufferedReader(new InputStreamReader(st));
        CSVReader cvsReader = new CSVReader(reader);

        cvsReader.readNext();
        String[] dataRow = cvsReader.readNext();
        assertThat(dataRow[0], is(entity.getEntityId()));
        assertThat(dataRow[1], is(entity.getEntityName()));
        assertThat(dataRow[2], is(entity.getParentEntityType().toString()));
        assertThat(dataRow[3], is("test client"));// Parent Entity Name
        cvsReader.close();
    }
}
