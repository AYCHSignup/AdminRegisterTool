/*******************************************************************************
 * Educational Online Test Delivery System
 * Copyright (c) 2013 American Institutes for Research
 *
 * Distributed under the AIR Open Source License, Version 1.0
 * See accompanying file AIR-License-1_0.txt or at
 * http://www.smarterapp.org/documents/American_Institutes_for_Research_Open_Source_Software_License.pdf
 ******************************************************************************/
package org.opentestsystem.delivery.testreg.integration;

import static org.hamcrest.core.Is.is;
import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertNotNull;
import static org.junit.Assert.assertNull;
import static org.junit.Assert.assertThat;
import static org.junit.Assert.fail;
import static org.opentestsystem.delivery.testreg.domain.TestRegPermission.ENTITY_MODIFY;
import static org.opentestsystem.delivery.testreg.domain.TestRegPermission.ENTITY_READ;

import java.io.BufferedReader;
import java.io.ByteArrayInputStream;
import java.io.InputStreamReader;
import java.util.Map;

import org.apache.poi.hssf.usermodel.HSSFWorkbook;
import org.apache.poi.ss.usermodel.Row;
import org.apache.poi.ss.usermodel.Sheet;
import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.delivery.testreg.domain.ClientEntity;
import org.opentestsystem.delivery.testreg.domain.GroupOfDistrictsEntity;
import org.opentestsystem.delivery.testreg.domain.HierarchyLevel;
import org.opentestsystem.delivery.testreg.domain.Sb11Entity;
import org.opentestsystem.shared.docs.annotation.ApiDocExample;
import org.opentestsystem.shared.search.domain.SearchResponse;
import org.springframework.mock.web.MockHttpServletResponse;

import au.com.bytecode.opencsv.CSVReader;

import com.google.common.collect.Maps;

@SuppressWarnings("unchecked")
public class GroupOfDistrictsControllerTest extends AbstractSecuredRestEmbeddedMongoTest {

    private Map<String, Object> params;
    private Map<String, String> uploadParams;

    @Before
    public void buildParams() {
        // Insert parent entity
        mongoTemplate.insert(new ClientEntity.Builder("testclient", "test client", "asfdasd-asdfas-asfds-afsf", "true").build());

        params = Maps.newHashMap();
        params.put("entityId", "1234");
        params.put("entityName", "WI GROUP OF DISTRICTS");
        params.put("parentEntityType", HierarchyLevel.CLIENT);
        params.put("parentEntityId", "testclient");
        params.put("stateAbbreviation", "WI");

        uploadParams = Maps.newHashMap();
        uploadParams.put("entityId", "1234");
    }

    @Test
    public void saveGroupOfDistrictsEntity() throws InterruptedException {
        GroupOfDistrictsEntity savedGroupOfDistrictsEntity = callPOSTRestService("/groupofdistricts", params,
                GroupOfDistrictsEntity.class, ENTITY_MODIFY);
        assertEquals("GroupOfDistrictsEntity should be created", 1, mongoTemplate.findAll(GroupOfDistrictsEntity.class)
                .size());
        assertNotNull(savedGroupOfDistrictsEntity);
    }

    @Test
    public void updateGroupOfDistrictsEntity() throws InterruptedException {
        GroupOfDistrictsEntity savedGroupOfDistrictsEntity = callPOSTRestService("/groupofdistricts", params,
                GroupOfDistrictsEntity.class, ENTITY_MODIFY);
        assertNotNull(savedGroupOfDistrictsEntity);
        params.put("id", savedGroupOfDistrictsEntity.getId());
        params.put("entityId", "890");
        GroupOfDistrictsEntity updatedGroupOfDistrictsEntity = callPUTRestService("/groupofdistricts/"
                + savedGroupOfDistrictsEntity.getId(), params, GroupOfDistrictsEntity.class, ENTITY_MODIFY);
        assertNotNull(updatedGroupOfDistrictsEntity);
        assertEquals("GroupOfDistrictsEntity should be updated", updatedGroupOfDistrictsEntity.getEntityId(), "890");
    }

    @Test
    public void findGroupOfDistrictsEntity() throws InterruptedException {
        GroupOfDistrictsEntity savedGroupOfDistrictsEntity = callPOSTRestService("/groupofdistricts", params,
                GroupOfDistrictsEntity.class, ENTITY_MODIFY);
        assertEquals("GroupOfDistrictsEntity should be created", 1, mongoTemplate.findAll(GroupOfDistrictsEntity.class)
                .size());
        assertNotNull(savedGroupOfDistrictsEntity);
        GroupOfDistrictsEntity fetchedGroupOfDistrictsEntity = callGETRestService("/groupofdistricts/"
                + savedGroupOfDistrictsEntity.getId(), GroupOfDistrictsEntity.class, ENTITY_READ);
        assertNotNull("GroupOfDistrictsEntity was null!", fetchedGroupOfDistrictsEntity);
    }

    @Test
    public void deleteGroupOfDistrictsEntity() throws InterruptedException {
        GroupOfDistrictsEntity savedGroupOfDistrictsEntity = callPOSTRestService("/groupofdistricts", params,
                GroupOfDistrictsEntity.class, ENTITY_MODIFY);
        assertEquals("GroupOfDistrictsEntity should be created", 1, mongoTemplate.findAll(GroupOfDistrictsEntity.class)
                .size());
        assertNotNull(savedGroupOfDistrictsEntity);
        try {
            callDeleteRestService("/groupofdistricts/" + savedGroupOfDistrictsEntity.getId(), ENTITY_MODIFY);
        } catch (Exception e) {
            fail("Cannot delete configuration");
        }
        GroupOfDistrictsEntity fetchedGroupOfDistrictsEntity = callGETRestService("/groupofdistricts/"
                + savedGroupOfDistrictsEntity.getId(), GroupOfDistrictsEntity.class, ENTITY_READ);
        assertNull("GroupOfDistrictsEntity was null!", fetchedGroupOfDistrictsEntity);
    }

    @Test
    public void searchGroupOfDistrictsEntity() throws InterruptedException {
        GroupOfDistrictsEntity savedGroupOfDistrictsEntity = callPOSTRestService("/groupofdistricts", params,
                GroupOfDistrictsEntity.class, ENTITY_MODIFY);
        assertEquals("GroupOfDistrictsEntity should be created", 1, mongoTemplate.findAll(GroupOfDistrictsEntity.class)
                .size());
        assertNotNull(savedGroupOfDistrictsEntity);

        Map<String, String> params = Maps.newHashMap();
        params.put("entityId", savedGroupOfDistrictsEntity.getEntityId());
        SearchResponse<Sb11Entity> resp = callGETRestService("/groupofdistrict" + buildQueryString(params),
                SearchResponse.class, ENTITY_READ);
        assertNotNull(resp);
        assertEquals("only one should be found", 1, resp.getReturnCount());
    }

    @Test
    @ApiDocExample(rank = -1)
    public void exportToExcelWithExtension() throws Exception {
        GroupOfDistrictsEntity entity = callPOSTRestService("/groupofdistricts", params, GroupOfDistrictsEntity.class, ENTITY_MODIFY);
        assertEquals("GroupOfDistrictsEntity should be created", 1, mongoTemplate.findAll(GroupOfDistrictsEntity.class)
                .size());
        assertNotNull(entity);

        MockHttpServletResponse response = callGETRestService1("/groupofdistricts.xls", ENTITY_READ);
        assertNotNull(response);
        assertEquals("Content-Type is not equal application/vnd.ms-excel", "application/vnd.ms-excel",
                response.getContentType());
        assertNotNull("State ExportExcel Data is null", response.getContentAsByteArray());
        byte[] resData = response.getContentAsByteArray();
        ByteArrayInputStream st = new ByteArrayInputStream(resData);
        HSSFWorkbook workbook = new HSSFWorkbook(st);
        Sheet sheet = workbook.getSheetAt(0);
        Row dataRow = sheet.getRow(1);
        assertThat(dataRow.getCell(0).getStringCellValue(), is(entity.getEntityId()));
        assertThat(dataRow.getCell(1).getStringCellValue(), is(entity.getEntityName()));
        assertThat(dataRow.getCell(2).getStringCellValue(), is(entity.getParentEntityType().toString()));
        assertThat(dataRow.getCell(3).getStringCellValue(), is("test client"));// Parent Entity Name

    }

    @Test
    @ApiDocExample(rank = -1)
    public void exportToExcelWithPageParams() throws Exception {
        GroupOfDistrictsEntity entity = callPOSTRestService("/groupofdistricts", params, GroupOfDistrictsEntity.class, ENTITY_MODIFY);
        assertEquals("GroupOfDistrictsEntity should be created", 1, mongoTemplate.findAll(GroupOfDistrictsEntity.class)
                .size());
        assertNotNull(entity);

        MockHttpServletResponse response = callGETRestService1("/groupofdistricts.xls" + buildQueryString(uploadParams), ENTITY_READ);
        assertNotNull(response);
        assertEquals("Content-Type is not equal application/vnd.ms-excel", "application/vnd.ms-excel",
                response.getContentType());
        assertNotNull("State ExportExcel Data is null", response.getContentAsByteArray());
        byte[] resData = response.getContentAsByteArray();
        ByteArrayInputStream st = new ByteArrayInputStream(resData);
        HSSFWorkbook workbook = new HSSFWorkbook(st);
        Sheet sheet = workbook.getSheetAt(0);
        Row dataRow = sheet.getRow(1);
        assertThat(dataRow.getCell(0).getStringCellValue(), is(entity.getEntityId()));
        assertThat(dataRow.getCell(1).getStringCellValue(), is(entity.getEntityName()));
        assertThat(dataRow.getCell(2).getStringCellValue(), is(entity.getParentEntityType().toString()));
        assertThat(dataRow.getCell(3).getStringCellValue(), is("test client"));// Parent Entity Name

    }

    @Test
    @ApiDocExample(rank = -1)
    public void exportToCSVWithExtension() throws Exception {
        GroupOfDistrictsEntity entity = callPOSTRestService("/groupofdistricts", params, GroupOfDistrictsEntity.class, ENTITY_MODIFY);
        assertEquals("GroupOfDistrictsEntity should be created", 1, mongoTemplate.findAll(GroupOfDistrictsEntity.class)
                .size());
        assertNotNull(entity);
        MockHttpServletResponse response = callGETRestService1("/groupofdistricts.csv", ENTITY_READ);
        assertNotNull(response);
        assertEquals("Content-Type is not equal application/csv", com.google.common.net.MediaType.CSV_UTF_8.toString(),
                response.getContentType());
        assertNotNull("State Export CSV Data is null", response.getContentAsByteArray());
        byte[] resData = response.getContentAsByteArray();

        ByteArrayInputStream st = new ByteArrayInputStream(resData);
        BufferedReader reader = new BufferedReader(new InputStreamReader(st));
        CSVReader cvsReader = new CSVReader(reader);
        cvsReader.readNext();
        String[] dataRow = cvsReader.readNext();
        assertThat(dataRow[0], is(entity.getEntityId()));
        assertThat(dataRow[1], is(entity.getEntityName()));
        assertThat(dataRow[2], is(entity.getParentEntityType().toString()));
        assertThat(dataRow[3], is("test client"));// Parent Entity Name
        cvsReader.close();
    }

    @Test
    @ApiDocExample(rank = -1)
    public void exportToCSVWithPageParams() throws Exception {
        GroupOfDistrictsEntity entity = callPOSTRestService("/groupofdistricts", params, GroupOfDistrictsEntity.class, ENTITY_MODIFY);
        assertEquals("GroupOfDistrictsEntity should be created", 1, mongoTemplate.findAll(GroupOfDistrictsEntity.class)
                .size());
        assertNotNull(entity);
        MockHttpServletResponse response = callGETRestService1("/groupofdistricts.csv" + buildQueryString(uploadParams), ENTITY_READ);
        assertNotNull(response);
        assertEquals("Content-Type is not equal application/csv", com.google.common.net.MediaType.CSV_UTF_8.toString(),
                response.getContentType());
        assertNotNull("State Export CSV Data is null", response.getContentAsByteArray());
        byte[] resData = response.getContentAsByteArray();

        ByteArrayInputStream st = new ByteArrayInputStream(resData);
        BufferedReader reader = new BufferedReader(new InputStreamReader(st));
        CSVReader cvsReader = new CSVReader(reader);
        cvsReader.readNext();
        String[] dataRow = cvsReader.readNext();
        assertThat(dataRow[0], is(entity.getEntityId()));
        assertThat(dataRow[1], is(entity.getEntityName()));
        assertThat(dataRow[2], is(entity.getParentEntityType().toString()));
        assertThat(dataRow[3], is("test client"));// Parent Entity Name
        cvsReader.close();
    }
}
