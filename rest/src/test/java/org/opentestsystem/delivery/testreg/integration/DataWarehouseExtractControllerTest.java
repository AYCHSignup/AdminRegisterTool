/*******************************************************************************
 * Educational Online Test Delivery System
 * Copyright (c) 2013 American Institutes for Research
 * 
 * Distributed under the AIR Open Source License, Version 1.0
 * See accompanying file AIR-License-1_0.txt or at
 * http://www.smarterapp.org/documents/American_Institutes_for_Research_Open_Source_Software_License.pdf
 ******************************************************************************/
package org.opentestsystem.delivery.testreg.integration;

import static org.hamcrest.CoreMatchers.notNullValue;
import static org.junit.Assert.assertThat;
import static org.mockito.Mockito.doNothing;

import java.util.HashMap;

import org.junit.Before;
import org.junit.Test;
import org.mockito.Mockito;
import org.opentestsystem.delivery.testreg.domain.TestRegPermission;
import org.opentestsystem.delivery.testreg.domain.warehouse.DwCallbackObject;
import org.opentestsystem.delivery.testreg.transformer.DwBatchHandler;
import org.opentestsystem.delivery.testreg.transformer.DwGenStarter;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.test.context.ContextConfiguration;

@ContextConfiguration(locations = { "classpath:dwextractcontrollertest.xml" })
public class DataWarehouseExtractControllerTest extends AbstractSecuredRestEmbeddedMongoTest {

    @Autowired
    private DwGenStarter dwGenStarter;

    @Autowired
    private DwBatchHandler handler;

    @Before
    public void init() {

        doNothing().when(dwGenStarter).kickoffDwProcess(Mockito.anyString());
        doNothing().when(handler).handleCallback((DwCallbackObject) Mockito.any());

        Mockito.reset(dwGenStarter, handler);

        wipeOutUserRoles();
    }

    @Test
    public void testStartExtract() throws Exception {

        callGETRestService("/datawarehouse/extract", Void.class, HttpStatus.NO_CONTENT,
                TestRegPermission.WAREHOUSE_EXTRACT_ADMIN);
    }

    @Test
    public void testExtractCallback() throws Exception {

        callPOSTRestService("/datawarehouse/extract/status", new HashMap<String, Object>(), Void.class, HttpStatus.OK);
    }

    @Test
    public void testGenerateGuid() throws Exception {
        String guid = callGETRestServicePlainText("/datawarehouse/guid");

        assertThat(guid, notNullValue());
    }
}